<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sim Astrobarbershop V1.2</title>
    
    <!-- LIBRARY GRAFIK -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg-dark: #121212;
            --bg-card: #1e1e1e;
            --primary: #d4af37; /* Gold */
            --primary-hover: #b5952f;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --danger: #ff5252;
            --success: #4caf50;
            --info: #2196f3;
            --savings: #00bcd4;
            --emergency: #e91e63;
            --border: #333;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        
        body { 
            background-color: var(--bg-dark); 
            color: var(--text-main); 
            display: flex; 
            width: 100vw;       
            height: 100vh;      
            overflow: hidden;   
            margin: 0; 
            padding: 0;
        }

        #app-content { display: flex; width: 100%; height: 100%; flex-direction: row; }

        aside { 
            width: 270px; 
            background-color: var(--bg-card); 
            border-right:1px solid var(--border); 
            display: flex; 
            flex-direction: column; 
            padding: 20px; 
            flex-shrink: 0;     
            height: 100%;
            overflow-y: auto;   
            transition: transform 0.3s ease-in-out;
            z-index: 999;
        }
        
        main { 
            flex:1;            
            padding: 25px; 
            overflow-y: auto;   
            position: relative;
            height: 100%;
            width: auto;
            display: flex;
            flex-direction: column;
        }

        /* LOGIN SCREEN */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-dark); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .login-box {
            background: var(--bg-card); padding: 40px; border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5); width: 90%; max-width: 400px;
            border:1px solid var(--primary); text-align: center;
        }
        .login-box h2 { color: var(--primary); margin-bottom: 20px; }
        .login-box input { margin-bottom: 15px; }
        .login-box .btn { width: 100%; margin-bottom: 10px; }
        .login-links a { color: var(--info); font-size: 0.9rem; cursor: pointer; text-decoration: underline; }

        .brand { font-size: 1.2rem; font-weight: bold; color: var(--primary); margin-bottom: 30px; text-align: center; letter-spacing: 1px; border-bottom: 2px solid var(--primary); padding-bottom: 10px; line-height: 1.4; }
        
        nav button { background: none; border: none; color: var(--text-muted); width: 100%; padding: 12px; text-align: left; cursor: pointer; font-size: 0.95rem; transition: 0.3s; border-radius: 8px; margin-bottom: 5px; display: flex; align-items: center; gap: 10px; }
        nav button:hover, nav button.active { background-color: rgba(212, 175, 55, 0.1); color: var(--primary); }
        nav button.logout-btn { margin-top: auto; color: var(--danger); }
        nav button.logout-btn:hover { background-color: rgba(255, 82, 82, 0.1); }

        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        h2 { font-weight: 400; border-left: 4px solid var(--primary); padding-left: 15px; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 25px; width: 100%; }
        .card { background-color: var(--bg-card); padding: 20px; border-radius: 12px; box-shadow: var(--shadow); border:1px solid var(--border); margin-bottom: 20px; }
        .card.danger-zone { border: 2px solid var(--danger); background-color: rgba(255, 82, 82, 0.05); }
        .card.report-card { border-left: 5px solid var(--primary); }
        .card.emergency-card { border-left: 5px solid var(--emergency); }
        
        .stat-label { color: var(--text-muted); font-size: 0.85rem; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-value { font-size: 1.6rem; font-weight: bold; color: var(--primary); }
        .stat-value-emergency { color: var(--emergency); }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .tab { padding: 8px 16px; cursor: pointer; background: #333; border-radius: 4px; font-size: 0.9rem; user-select: none; }
        .tab.active { background: var(--primary); color: #000; font-weight: bold; }

        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; color: var(--text-muted); font-size: 0.9rem; }
        
        /* MODIFIKASI INPUT STYLE - FONT STANDARD */
        input, select, textarea { width: 100%; padding: 12px; background-color: #2c2c2c; border: 1px solid var(--border); border-radius: 6px; color: white; font-size: 0.95rem; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); }
        
        /* Helper for currency inputs - Standard Font */
        input.money-input { text-align: right; }
        
        button:disabled { opacity: 0.6; cursor: not-allowed; }

        button.btn { background-color: var(--primary); color: #000; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; font-size: 0.9rem; }
        button.btn:hover:not(:disabled) { background-color: var(--primary-hover); }
        button.btn-danger { background-color: var(--danger); color: white; }
        button.btn-info { background-color: var(--info); color: white; }
        button.btn-secondary { background-color: #555; color: white; }
        button.btn-warning { background-color: #ff9800; color: white; }
        button.btn-print { background-color: #607d8b; color: white; }
        button.btn-success { background-color: var(--success); color: white; }
        button.btn-emergency { background-color: var(--emergency); color: white; }
        button.btn-sm { padding: 4px 8px; font-size: 0.8rem; }
        
        .table-container { overflow-x: auto; max-height: 500px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        th, td { padding: 10px 12px; text-align: left; border-bottom:1px solid var(--border); vertical-align: top; }
        th { background-color: #252525; color: var(--text-muted); font-weight: 600; position: sticky; top: 0; }
        
        tr.voided-row { opacity: 0.5; text-decoration: line-through; background-color: rgba(255, 82, 82, 0.05); }
        
        .detail-list { font-size: 0.85rem; color: var(--text-muted); line-height:1.4; display: flex; flex-direction: column; gap: 4px; }
        .detail-item { display: flex; justify-content: space-between; border-bottom: 1px dashed #333; padding: 2px 0; }
        .detail-item span:last-child { font-weight: bold; color: var(--text-main); }

        .section { display: none; animation: fadeIn 0.4s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }

        #toast { visibility: hidden; min-width: 250px; background-color: var(--primary); color: #000; text-align: center; border-radius: 4px; padding: 16px; position: fixed; z-index: 1000; right: 30px; bottom: 30px; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; display: inline-block; }
        .badge-locked { background-color: rgba(255, 152, 0, 0.2); color: #ff9800; }
        .badge-in { background-color: rgba(76, 175, 80, 0.2); color: #4caf50; }
        .badge-out { background-color: rgba(255, 82, 82, 0.2); color: #ff5252; }
        .badge-void { background-color: #333; color: #777; border: 1px solid #555; }
        
        .badge-paid { background-color: rgba(76, 175, 80, 0.2); color: var(--success); border: 1px solid var(--success); }
        .badge-unpaid { background-color: rgba(255, 82, 82, 0.2); color: var(--danger); border: 1px solid var(--danger); }

        .action-btns { display: flex; gap: 5px; }
        .action-btns button { padding: 4px 8px; font-size: 0.75rem; }
        
        .sub-header { font-size: 1rem; color: var(--primary); margin: 15px 0 10px 0; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .report-divider { border-top: 1px dashed #444; margin: 10px 0; }

        /* MODIFIKASI: Underline Style untuk Laporan (Seperti Gambar) */
        .report-summary-row {
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 8px; 
            font-size: 0.95rem;
            padding-bottom: 4px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05); /* Garis pemisah halus */
            align-items: baseline;
        }
        
        /* Underline pada text Keterangan dan Nominal */
        .report-summary-row span {
            text-decoration: underline;
            text-decoration-color: rgba(255, 255, 255, 0.2); /* Warna underline tipis */
            text-underline-offset: 5px;
        }

        .report-summary-row.total span {
            text-decoration: underline;
            text-decoration-color: var(--primary); /* Warna underline emas untuk total */
            text-underline-offset: 5px;
        }
        
        .report-summary-row.total { 
            font-weight: bold; 
            font-size: 1.1rem; 
            color: var(--primary); 
            margin-top: 10px; 
            padding-top: 10px; 
            border-top: 1px solid #444; 
        }
        .report-summary-row.negative { color: var(--danger); }
        
        .owner-input-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .owner-input-row input { margin-bottom: 0; }
        .owner-input-row button { flex-shrink: 0; }

        .owner-shares-list { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; max-height: 200px; overflow-y: auto; }
        .owner-share-item { display: flex; gap: 10px; align-items: center; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 4px; }
        .owner-share-info { flex: 1; }
        .owner-share-label { font-size: 0.9rem; color: var(--text-muted); }
        .owner-share-calc { font-size: 1.1rem; font-weight: bold; color: var(--success); }

        /* --- SLIP BAGI HASIL STYLE (V1.7.2) --- */
        .slip-row { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 4px; padding-bottom: 2px; }
        .slip-row.final { border-top: 1px solid var(--primary); margin-top: 8px; padding-top: 8px; font-weight: bold; font-size: 1.1rem; color: var(--success); }
        .slip-deduction { color: var(--danger); }
        .slip-card { background: #fff; color: #000; padding: 15px; margin-bottom: 10px; border-radius: 4px; border: 1px dashed #ccc; }
        
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: none; justify-content: center; align-items: center; color: var(--primary); font-size: 1.5rem; flex-direction: column; gap: 15px; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(212,175,55,0.3); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- MODAL STYLES --- */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 3000; 
            left: 0; top: 0; 
            width: 100%; height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.8); 
            backdrop-filter: blur(5px);
            justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: var(--bg-card);
            margin: auto;
            padding: 30px;
            border: 1px solid var(--primary);
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.7);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-lg {
            max-width: 700px;
        }
        .close-modal {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 20px;
            top: 10px;
        }
        .close-modal:hover { color: #fff; }

        /* --- MOBILE RESPONSIVE FIXES --- */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1001;
            background: var(--primary);
            color: #000;
            border: none;
            padding: 10px 15px;
            border-radius:5px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        @media (max-width: 768px) {
            aside {
                position: fixed;
                left: -280px; 
                top: 0;
                bottom: 0;
                width: 270px;
                box-shadow: 2px 0 10px rgba(0,0,0,0.5);
            }
            aside.open {
                left: 0;
            }
            main {
                width: 100%;
                padding: 60px 15px 15px 15px; 
            }
            .mobile-menu-toggle {
                display: block;
            }
            .stats-grid {
                grid-template-columns: 1fr; 
            }
            .grid-2, .grid-3 {
                grid-template-columns: 1fr; 
            }
        }

        /* PRINT STYLES */
        @media print {
            body { background-color: white; color: black; height: auto; overflow: visible; display: block; font-size: 11pt; -webkit-print-color-adjust: exact; }
            main { padding: 0; margin: 0; width: 100%; overflow: visible; }
            aside, nav, .no-print, .tabs, .btn, .action-btns, #toast, #loading-overlay, .form-group, .login-screen, .mobile-menu-toggle, .no-print-print { display: none !important; }
            .section { display: none !important; }
            #laporan-keuangan { display: block !important; }
            #tab-live { display: block !important; }
            #report-result { display: block !important; }
            #final-result { display: block !important; margin-top: 20px; }
            
            #laporan-keuangan { padding: 20px; }
            .card { 
                border:1px solid #ccc; 
                box-shadow: none; 
                padding: 15px; 
                margin-bottom: 20px; 
                break-inside: avoid; 
                page-break-inside: avoid; 
                background: white; 
                color: black;
            }
            .card.report-card { border: 2px solid black; }
            .card.emergency-card { border: 1px solid black; }
            
            .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
            .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
            
            table { width: 100%; border-collapse: collapse; font-size: 10pt; margin-top: 0; }
            th, td { border: 1px solid #000; padding: 6px; color: black; text-align: left; }
            th { background-color: #eee !important; font-weight: bold; color: black !important; }

            h2, .sub-header { display: none; } 
            .print-only { display: block !important; margin-bottom: 20px; text-align: center; }
            .print-only h1 { font-size: 18pt; color: black; margin-bottom: 5px; font-weight: bold; text-transform: uppercase; }
            .print-only h2 { font-size: 12pt; color: black; font-weight: normal; display: block !important;}
            
            .stat-value { color: black; }
            .report-summary-row.total { color: black; border-top: 2px solid black; }
            .stat-label { color: #555; }
            
            input, select { display: none; } 
            
            .owner-shares-list { max-height: none; overflow: visible; }
            .owner-share-item { background: none; border-bottom: 1px solid #eee; padding: 5px 0; }
            .owner-share-calc { color: black; font-weight: bold; }
            
            /* Print Slip Style */
            .slip-card { border: 1px solid #000; color: #000; background: #fff; page-break-inside: avoid; }
            .slip-deduction { color: #000; }
            .slip-row.final { color: #000; border-top: 1px solid #000; }
        }
        
        .print-only { display: none; } 
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- MOBILE MENU TOGGLE BUTTON -->
    <button class="mobile-menu-toggle" onclick="document.querySelector('aside').classList.toggle('open')">‚ò∞ MENU</button>

    <!-- LOGIN SCREEN -->
    <div id="login-screen">
        <div class="login-box">
            <h2>BARBER MANAGER</h2>
            <div class="form-group"><input type="email" id="login-email" placeholder="Email"></div>
            <div class="form-group"><input type="password" id="login-pass" placeholder="Password"></div>
            <button class="btn" id="btn-login" onclick="window.handleLogin()">MASUK</button>
            <div class="login-links">
                <a onclick="window.handleResetPassword()">Lupa Password?</a>
            </div>
            <div style="margin-top:20px; border-top:1px solid #333; padding-top:10px;">
                <p style="font-size:0.8rem; color:#aaa;">Belum punya akun? Hubungi Owner.</p>
            </div>
        </div>
    </div>

    <!-- APP CONTENT -->
    <div id="app-content" class="hidden" style="display: flex; height: 100vh;">
        
        <aside class="no-print">
            <div class="brand" id="brand-name">BARBERSHOP MANAGER</div>
            <nav>
                <button class="nav-btn active" onclick="window.showSection('dashboard')">üìä Dashboard</button>
                <button class="nav-btn" onclick="window.showSection('transaksi')">üíà Transaksi</button>
                
                <!-- OWNER ONLY MENU -->
                <div class="owner-menu hidden">
                    <button class="nav-btn" onclick="window.showSection('master-data')">üì¶ Master Data</button>
                    <button class="nav-btn" onclick="window.showSection('gaji-karyawan')">üí∞ Gaji Karyawan</button>
                    <button class="nav-btn" onclick="window.showSection('laporan-keuangan')">üìà Laporan & Tutup Buku</button>
                    <button class="nav-btn" onclick="window.showSection('pengaturan')">‚öôÔ∏è Pengaturan & Akun</button>
                </div>

                <!-- STAFF MENU -->
                <div class="staff-menu hidden">
                    <button class="nav-btn" onclick="window.showSection('laporan-kas-staff')">üìâ Laporan Kas Saya</button>
                </div>

                <button class="nav-btn logout-btn" onclick="window.handleLogout()">üö™ Logout</button>
            </nav>
            <div style="margin-top:auto; padding-top:20px; font-size:0.8rem; color:#666;">
                Login sebagai: <br> <strong id="user-display-email" style="color:var(--primary)"></strong>
            </div>
        </aside>

        <main>
            <div id="toast">Notifikasi</div>

            <!-- 1. DASHBOARD -->
            <section id="dashboard" class="section active">
                <header>
                    <h2>Ringkasan Bisnis</h2>
                    <p id="current-date" style="color: var(--text-muted);"></p>
                </header>
                
                <!-- GRAFIK ATAS (FULL WIDTH) -->
                <div class="card" style="margin-bottom: 20px; padding: 10px 20px; min-height: 160px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h4 style="margin: 0; font-size: 1rem; color:var(--text-muted);">Trend Pendapatan (6 Bulan)</h4>
                    </div>
                    <div style="height: 120px; width: 100%;">
                        <canvas id="chart-income"></canvas>
                    </div>
                </div>

                <!-- GRAFIK BAWAH (BERJAJAR) -->
                <div class="grid-2" style="margin-bottom: 20px;">
                    <!-- GRAFIK KOMPOSISI -->
                    <div class="card" style="min-height: 250px; padding: 15px;">
                        <h4 style="margin-bottom:15px; font-size: 1rem; color:var(--text-muted);">Komposisi Pendapatan</h4>
                        <div style="height: 180px; position: relative;">
                            <canvas id="chart-pie"></canvas>
                        </div>
                    </div>

                    <!-- GRAFIK TOP BARBER -->
                    <div class="card" style="min-height: 250px; padding: 15px;">
                        <h4 style="margin-bottom:15px; font-size: 1rem; color:var(--text-muted);">Top 5 Performer</h4>
                        <div style="height: 180px; display: flex; justify-content: center;">
                            <canvas id="chart-barbers" style="max-height: 100%; max-width: 100%;"></canvas>
                        </div>
                    </div>
                </div>

                <!-- CARDS STATISTIK -->
                <div class="stats-grid">
                    <div class="card"><div class="stat-label">Total Modal Masuk</div><div class="stat-value" id="dash-cash">Rp 0</div></div>
                    <div class="card" style="border-color: var(--savings);"><div class="stat-label">Tabungan</div><div class="stat-value" id="dash-savings" style="color: var(--savings)">Rp 0</div></div>
                    <div class="card" style="border-color: var(--emergency);"><div class="stat-label">Dana Darurat</div><div class="stat-value" id="dash-emergency" style="color: var(--emergency)">Rp 0</div></div>
                    <div class="card"><div class="stat-label">Pendapatan Bln Ini</div><div class="stat-value" id="dash-income">Rp 0</div></div>
                    <div class="card"><div class="stat-label">Pengeluaran Bln Ini</div><div class="stat-value" id="dash-expense" style="color: var(--danger)">Rp 0</div></div>
                </div>
            </section>

            <!-- 2. TRANSAKSI -->
            <section id="transaksi" class="section">
                <header><h2>Input Transaksi Harian</h2></header>
                <div class="grid-2">
                    <div class="card">
                        <form id="form-transaction" onsubmit="window.handleTransactionSubmit(event)">
                            <div class="form-group"><label>Jenis Transaksi</label><select id="trx-type" onchange="window.toggleTransactionFields()"><option value="income">Pemasukan (Omset)</option><option value="expense">Pengeluaran</option></select></div>
                            <div class="form-group"><label>Tanggal</label><input type="date" id="trx-date" required></div>
                            
                            <div id="income-fields">
                                <div class="form-group">
                                    <label>Kategori</label>
                                    <select id="trx-category" onchange="window.toggleCategoryFields()">
                                        <option value="service">Layanan (Jasa Potong)</option>
                                        <option value="good">Penjualan Barang (Produk)</option>
                                    </select>
                                </div>

                                <div id="service-specific">
                                    <div class="form-group">
                                        <label>Karyawan (Barber)</label>
                                        <select id="trx-employee" onchange="window.showEmployeeCommInfo()">
                                            <option value="">-- Pilih --</option>
                                        </select>
                                        <small id="emp-comm-hint" style="color: var(--primary); font-size: 0.8rem; display:block; margin-top:4px;"></small>
                                    </div>
                                    <div class="form-group">
                                        <label>Layanan</label>
                                        <select id="trx-product" onchange="window.autoFillPrice()">
                                            <option value="">-- Pilih Layanan --</option>
                                        </select>
                                    </div>
                                </div>

                                <div id="good-specific" style="display:none;">
                                    <div class="form-group">
                                        <label>Barang</label>
                                        <select id="trx-good" onchange="window.autoFillPriceGood()">
                                            <option value="">-- Pilih Barang --</option>
                                        </select>
                                    </div>
                                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 10px;">
                                        Stok Tersedia: <span id="stock-display" style="color: var(--success); font-weight: bold;">0</span>
                                    </div>
                                </div>
                                
                                <div class="grid-2" style="gap:10px;">
                                    <div class="form-group"><label>Harga Satuan</label><input type="number" id="trx-price" readonly style="background:#333; color: #888;" class="money-input"></div>
                                    <div class="form-group"><label>Jumlah</label><input type="number" id="trx-qty" value="1" min="1" oninput="window.updateTotalPrice()"></div>
                                </div>
                            </div>
                            
                            <div id="expense-fields" style="display:none;">
                                <div class="form-group"><label>Keterangan / Item</label><input type="text" id="trx-desc" placeholder="Contoh: Beli Sabun, Bayar Listrik"></div>
                            </div>
                            
                            <div class="form-group"><label>Total Nominal (Rp)</label><input type="text" id="trx-amount" class="money-input" inputmode="numeric" placeholder="0" required></div>
                            
                            <div class="action-group" style="display:flex; gap:10px;">
                                <button type="submit" class="btn" id="btn-save-trx" style="flex:1">SIMPAN TRANSAKSI</button>
                                <button type="button" class="btn btn-secondary" id="btn-cancel-trx" onclick="window.resetTransactionForm()" style="display:none;">BATAL</button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="card">
                        <h3>Riwayat Transaksi</h3>
                        <div class="grid-2" style="gap:10px; margin-bottom:10px;">
                            <div class="form-group"><label>Mulai</label><input type="date" id="trx-history-start" onchange="window.resetTransactionPagination()"></div>
                            <div class="form-group"><label>Selesai</label><input type="date" id="trx-history-end" onchange="window.resetTransactionPagination()"></div>
                        </div>
                        
                        <div class="table-container">
                            <table id="today-trx-table">
                                <thead><tr><th>Tipe</th><th>Info</th><th>Jml</th><th>Total</th><th>Aksi</th></tr></thead>
                                <tbody></tbody></table>
                        </div>
                        <!-- PAGINATION BUTTON -->
                        <div style="text-align: center; margin-top: 10px;">
                            <button class="btn btn-secondary btn-sm" id="btn-load-more-trx" onclick="window.loadMoreTransactions()">MUAT LEBIH BANYAK</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 3. MASTER DATA -->
            <section id="master-data" class="section">
                <header><h2>Master Data</h2></header>
                <div class="grid-3">
                    <div class="card">
                        <h3>Layanan / Jasa</h3>
                        <div class="form-group"><input type="text" id="prod-name" placeholder="Nama Layanan"></div>
                        <div class="form-group"><input type="text" id="prod-price" placeholder="Harga Jual (Rp)" class="money-input" inputmode="numeric"></div>
                        <div class="action-group" style="display:flex; gap:10px;">
                            <button class="btn" id="btn-save-prod" onclick="window.saveProduct()">TAMBAH</button>
                            <button class="btn btn-secondary" id="btn-cancel-prod" onclick="window.resetProductForm()" style="display:none;">Batal</button>
                        </div>
                        <div class="table-container" style="margin-top:15px;">
                            <table id="product-table"><thead><tr><th>Nama</th><th>Harga</th><th>Aksi</th></tr></thead><tbody></tbody></table>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>Data Karyawan</h3>
                        <div class="form-group"><input type="text" id="emp-name" placeholder="Nama Karyawan"></div>
                        <div class="grid-2" style="gap:10px;">
                            <div class="form-group"><label>Tipe Komisi</label><select id="emp-comm-type"><option value="percent">Persen (%)</option><option value="nominal">Nominal (Rp)</option></select></div>
                            <div class="form-group"><label>Nilai</label><input type="text" id="emp-comm-value" placeholder="cth: 20 atau 10000" class="money-input" inputmode="numeric"></div>
                        </div>
                        <div class="action-group" style="display:flex; gap:10px;">
                            <button class="btn" id="btn-save-emp" onclick="window.saveEmployee()">TAMBAH</button>
                            <button class="btn btn-secondary" id="btn-cancel-emp" onclick="window.resetEmployeeForm()" style="display:none;">Batal</button>
                        </div>
                        <div class="table-container" style="margin-top:15px;">
                            <table id="employee-table"><thead><tr><th>Nama</th><th>Komisi</th><th>Aksi</th></tr></thead><tbody></tbody></table>
                        </div>
                    </div>

                    <div class="card" style="border-top: 3px solid var(--info);">
                        <h3>Stok Barang</h3>
                        <div class="form-group"><input type="text" id="good-name" placeholder="Nama Barang"></div>
                        <div class="form-group"><input type="text" id="good-price" placeholder="Harga Jual (Rp)" class="money-input" inputmode="numeric"></div>
                        <div class="form-group"><input type="number" id="good-stock" placeholder="Stok Awal / Restock"></div>
                        <div class="action-group" style="display:flex; gap:10px;">
                            <button class="btn btn-info" id="btn-save-good" onclick="window.saveGood()">TAMBAH/UPDATE</button>
                            <button class="btn btn-secondary" id="btn-cancel-good" onclick="window.resetGoodForm()" style="display:none;">Batal</button>
                        </div>
                        <div class="table-container" style="margin-top:15px;">
                            <table id="good-table"><thead><tr><th>Nama</th><th>Harga</th><th>Stok</th><th>Aksi</th></tr></thead><tbody></tbody></table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 4. GAJI KARYAWAN -->
            <section id="gaji-karyawan" class="section">
                <header>
                    <h2>Gaji Karyawan</h2>
                    <button class="btn btn-warning btn-sm" onclick="window.openKasBonModal()">üí∏ INPUT KAS BON</button>
                </header>
                
                <div class="tabs no-print">
                    <div class="tab active" onclick="window.switchPayrollTab('live')">Live Preview</div>
                    <div class="tab" onclick="window.switchPayrollTab('history')">Riwayat (Terkunci)</div>
                </div>
                
                <div id="tab-pay-live" class="tab-content">
                    <div class="card no-print" style="margin-bottom: 20px;">
                        <div class="grid-2">
                            <div class="form-group"><label>Mulai</label><input type="date" id="pay-start"></div>
                            <div class="form-group"><label>Selesai</label><input type="date" id="pay-end"></div>
                        </div>
                        <div class="action-group" style="display:flex; gap:10px; flex-wrap: wrap;">
                            <button class="btn" onclick="window.calculatePayroll()">Hitung Gaji</button>
                            <button class="btn btn-warning" id="btn-save-payroll" onclick="window.savePayrollHistory()">Simpan & Kunci Riwayat</button>
                        </div>
                        <p style="font-size:0.8rem; color:var(--text-muted); margin-top:10px;">
                            *Periode yang sudah terkunci tidak dapat dihitung ulang. Kas Bon otomatis dipotong.
                        </p>
                    </div>
                    <div class="card">
                        <div class="table-container" style="max-height: 500px;">
                            <table id="payroll-table">
                                <thead>
                                    <tr>
                                        <th style="width: 20%">Nama</th>
                                        <th style="width: 8%; text-align:center">Cust</th>
                                        <th style="width: 15%; text-align:right">Komisi</th>
                                        <th style="width: 12%; text-align:right">Bonus</th>
                                        <th style="width: 15%; text-align:right; color:var(--text-main)">Gaji Kotor</th>
                                        <th style="width: 12%; text-align:right; color:var(--danger)">Kas Bon</th>
                                        <th style="width: 13%; text-align:right; color:var(--success); font-weight:bold;">Total Terima</th>
                                        <th style="width:5%">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div id="tab-pay-history" class="tab-content" style="display:none;">
                    <div class="card">
                        <h3>Riwayat Gaji (Terkunci)</h3>
                        <div class="table-container">
                            <table id="payroll-history-table">
                                <thead>
                                    <tr>
                                        <th>Periode</th>
                                        <th>Nama</th>
                                        <th style="text-align:center">Cust</th>
                                        <th style="text-align:right">Gaji</th>
                                        <th style="text-align:center">Status</th>
                                        <th>Tgl Bayar</th>
                                        <th>Detail & Bon</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody></tbody></table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 5. LAPORAN & TUTUP BUKU -->
            <section id="laporan-keuangan" class="section">
                <header>
                    <h2>Laporan & Tutup Buku</h2>
                    <div class="action-group no-print">
                        <button class="btn btn-info" onclick="window.exportToExcel()">üìä Export Excel (CSV)</button>
                        <button class="btn btn-print" onclick="window.printReport()">üñ®Ô∏è Cetak Laporan</button>
                        <button class="btn btn-secondary" onclick="window.backupData()">üíæ Backup JSON</button>
                    </div>
                </header>
                
                <div class="tabs no-print">
                    <div class="tab active" onclick="window.switchReportTab('live')">Live Preview</div>
                    <div class="tab" onclick="window.switchReportTab('history')">Riwayat (Terkunci)</div>
                </div>
                
                <div id="tab-live" class="tab-content">
                    <div class="card no-print">
                        <div class="grid-2" id="rep-date-filters">
                            <div class="form-group"><label>Mulai</label><input type="date" id="rep-start"></div>
                            <div class="form-group"><label>Selesai</label><input type="date" id="rep-end"></div>
                        </div>
                        <div style="text-align: right; margin-bottom: 10px;">
                            <button class="btn" onclick="window.generateFinancialReport()">BUAT LAPORAN</button>
                        </div>
                    </div>
                    
                    <div id="report-result" style="display:none;">
                        
                        <div class="print-only">
                            <h1 id="print-business-name">LAPORAN KEUANGAN</h1>
                            <h2 id="print-period"></h2>
                        </div>

                        <!-- 1. LAPORAN ARUS KAS -->
                        <div class="card report-card">
                            <h3 class="sub-header">Laporan Arus Kas (Cash Flow)</h3>
                            <div class="report-summary-row">
                                <span>Saldo Awal Kas (Modal Awal)</span>
                                <span id="rep-cash-open">Rp 0</span>
                            </div>
                            <div class="report-summary-row">
                                <span>(+) Total Modal Masuk (Periode Ini)</span>
                                <span id="rep-cash-inject">Rp 0</span>
                            </div>
                            <div class="report-summary-row">
                                <span>(+) Pendapatan Kotor</span>
                                <span id="rep-income-total">Rp 0</span>
                            </div>
                            <div class="report-summary-row">
                                <span>(-) Pengeluaran Operasional</span>
                                <span id="rep-exp-total" style="color:var(--danger)">Rp 0</span>
                            </div>
                            <div class="report-summary-row">
                                <span>(-) Gaji Karyawan (Termasuk Bonus)</span>
                                <span id="rep-salary-total">Rp 0</span>
                            </div>
                            <div class="report-summary-row">
                                <span>(-) Setor Tabungan</span>
                                <span id="rep-savings-out">Rp 0</span>
                            </div>
                            <div class="report-summary-row">
                                <span>(+) Penarikan Tabungan ke Kas</span>
                                <span id="rep-savings-in">Rp 0</span>
                            </div>
                            <div class="report-summary-row">
                                <span>(-) Setor Dana Darurat</span>
                                <span id="rep-emergency-out" style="color:var(--emergency)">Rp 0</span>
                            </div>
                            <div class="report-summary-row">
                                <span>(+) Penarikan Dana Darurat ke Kas</span>
                                <span id="rep-emergency-in">Rp 0</span>
                            </div>
                            <div class="report-summary-row total">
                                <span>= Saldo Akhir Kas (Hasil Operasional)</span>
                                <span id="rep-cash-close">Rp 0</span>
                            </div>
                        </div>

                        <!-- 2. LAPORAN PERUBAHAN TABUNGAN -->
                        <div class="card report-card" style="border-left-color: var(--savings);">
                            <h3 class="sub-header">Laporan Perubahan Tabungan</h3>
                            <div class="report-summary-row">
                                <span>Saldo Awal Tabungan</span>
                                <span id="rep-sav-open">Rp 0</span>
                            </div>
                            <div class="report-summary-row">
                                <span>(+) Setoran Selama Periode</span>
                                <span id="rep-sav-deposit" style="color:var(--success)">Rp 0</span>
                            </div>
                            <div class="report-summary-row">
                                <span>(-) Penarikan Selama Periode</span>
                                <span id="rep-sav-withdraw" style="color:var(--danger)">Rp 0</span>
                            </div>
                            <div class="report-summary-row total" style="color:var(--savings)">
                                <span>= Saldo Akhir Tabungan</span>
                                <span id="rep-sav-close">Rp 0</span>
                            </div>
                        </div>

                        <!-- 3. LAPORAN PERUBAHAN DANA DARURAT -->
                        <div id="emergency-report-section" class="card emergency-card" style="display:none;">
                            <h3 class="sub-header" style="color:var(--emergency)">Laporan Perubahan Dana Darurat</h3>
                            <div class="report-summary-row">
                                <span>Saldo Awal Dana Darurat</span>
                                <span id="rep-emerg-open">Rp 0</span>
                            </div>
                            <div class="report-summary-row">
                                <span>(+) Setoran Selama Periode</span>
                                <span id="rep-emerg-deposit" style="color:var(--success)">Rp 0</span>
                            </div>
                            <div class="report-summary-row">
                                <span>(-) Penarikan Selama Periode</span>
                                <span id="rep-emerg-withdraw" style="color:var(--danger)">Rp 0</span>
                            </div>
                            <div class="report-summary-row total" style="color:var(--emergency)">
                                <span>= Saldo Akhir Dana Darurat</span>
                                <span id="rep-emerg-close">Rp 0</span>
                            </div>
                        </div>

                        <!-- 4. LAPORAN LABA RUGI -->
                        <div class="card report-card">
                            <h3 class="sub-header">Laporan Laba Rugi (Profit & Loss)</h3>
                            <div class="report-summary-row">
                                <span>Pendapatan Kotor</span>
                                <span id="pl-gross">Rp 0</span>
                            </div>
                            <div class="report-summary-row">
                                <span>Beban Operasional (Expense)</span>
                                <span id="pl-exp" style="color:var(--danger)">Rp 0</span>
                            </div>
                            <div class="report-summary-row">
                                <span>Beban Gaji Karyawan</span>
                                <span id="pl-salary">Rp 0</span>
                            </div>
                            <div class="report-summary-row total">
                                <span>= LABA BERSIH OPERASIONAL</span>
                                <span id="pl-net">Rp 0</span>
                            </div>
                        </div>

                        <!-- 5. DETAIL TRANSAKSI -->
                        <div class="card">
                            <h4 class="sub-header">Rincian Pemasukan</h4>
                            <div class="table-container" style="max-height:300px;">
                                <table id="report-inc-table">
                                    <thead><tr><th>Tgl</th><th>Kategori</th><th>Item</th><th>Info Tambahan</th><th>Jml</th><th>Nominal</th></tr></thead>
                                    <tbody></tbody></table>
                            </div>
                        </div>

                        <div class="card">
                            <h4 class="sub-header">Rincian Pengeluaran</h4>
                            <div class="table-container" style="max-height:300px;">
                                <table id="report-exp-table">
                                    <thead><tr><th>Tgl</th><th>Keterangan</th><th>Nominal</th></thead>
                                    <tbody></tbody></table>
                            </div>
                        </div>

                        <!-- 6. TUTUP BUKU & BAGI HASIL -->
                        <div class="card no-print" style="border: 2px solid var(--savings);">
                            <h3 style="color: var(--savings)">Tutup Buku & Bagi Hasil Owner</h3>
                            <p style="font-size:0.85rem; color:#aaa; margin-bottom:10px;">
                                Perhitungan Bagi Hasil didasarkan pada <strong>Laba Bersih Dikurangi Tabungan & Dana Darurat</strong>.
                                <br><strong style="color:var(--primary)">Kasbon Owner akan otomatis dipotong dari Bagi Hasil.</strong>
                            </p>
                            <div class="grid-2">
                                <div>
                                    <div class="stat-label">Laba Bersih Saat Ini</div>
                                    <div class="stat-value" id="temp-op-profit" style="color: var(--success)">Rp 0</div>
                                </div>
                                <div>
                                    <div class="grid-2" style="gap:10px;">
                                        <div><label>Nominal Setor Tabungan</label><input type="text" id="input-savings-amount" class="money-input" inputmode="numeric" placeholder="0"></div>
                                        <div><label style="color:var(--emergency)">Nominal Dana Darurat</label><input type="text" id="input-emergency-amount" class="money-input" inputmode="numeric" placeholder="0"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="owner-shares-list" id="owner-shares-list-container">
                                <!-- Dynamic Owner Inputs will be injected here -->
                            </div>

                            <!-- BUTTONS: 2 STEP PROCESS -->
                            <div style="text-align: right; display: flex; gap: 10px; margin-top: 20px; border-top: 1px solid #333; padding-top: 20px;">
                                <button class="btn" onclick="window.processClosingMonth()">1. PROSES (LIHAT HASIL)</button>
                                <button class="btn btn-success" id="btn-save-lock-report" onclick="window.saveClosingMonth()" style="display:none;">2. SIMPAN & KUNCI LAPORAN</button>
                            </div>
                        </div>

                        <!-- FINAL RESULT DISPLAY (SLIP) -->
                        <div id="final-result" style="display:none;">
                            <div class="card" style="border-color: var(--success);">
                                <h3 style="color: var(--success)">Slip Bagi Hasil & Saldo Kas</h3>
                                <div id="final-shares-display">
                                    <!-- Dynamic Results (Slip Cards) will be injected here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-history" class="tab-content" style="display:none;">
                    <!-- CONTAINER FOR DETAILED HISTORY CARDS -->
                    <div id="history-container">
                        <!-- Cards will be injected via JS -->
                    </div>
                </div>
            </section>

            <!-- 6. PENGATURAN -->
            <section id="pengaturan" class="section">
                <header><h2>Pengaturan Bisnis & Akun</h2></header>
                <div class="grid-2">
                    <div class="card">
                        <h3>‚öôÔ∏è Konfigurasi Bisnis</h3>
                        <div class="form-group"><label>Nama Usaha</label><input type="text" id="conf-business-name" placeholder="Barbershop Anda"></div>
                        <button class="btn btn-info" style="width:100%" onclick="window.saveConfig()">Simpan Konfigurasi</button>
                    </div>
                    
                    <div class="card">
                        <h3>üë• Konfigurasi Owner & Bagi Hasil</h3>
                        <p style="font-size:0.8rem; color:#aaa; margin-bottom:15px;">
                            Tambahkan owner dan atur persentase bagi hasil default. Total persentase sebaiknya 100%.
                        </p>
                        <div id="owner-settings-container" style="margin-bottom: 15px;">
                            <!-- Dynamic Owner Inputs injected here -->
                        </div>
                        <button class="btn btn-secondary btn-sm" onclick="window.addOwnerConfig()">+ Tambah Owner</button>
                    </div>
                </div>

                <div class="grid-2">
                    <div class="card">
                        <h3>üë§ Tambah Akun User</h3>
                        <p style="font-size:0.8rem; color:#aaa; margin-bottom:10px;">Buat akun untuk karyawan atau owner lain.</p>
                        <div class="form-group"><label>Email</label><input type="email" id="new-user-email" placeholder="email@contoh.com"></div>
                        <div class="form-group"><label>Password Sementara</label><input type="text" id="new-user-pass" placeholder="Password awal"></div>
                        <div class="form-group"><label>Role / Jabatan</label><select id="new-user-role"><option value="staff">Staff (Karyawan)</option><option value="owner">Owner (Penuh Akses)</option></select></div>
                        <button class="btn btn-success" style="width:100%; background-color: var(--success); color:white;" onclick="window.registerNewUser()">BUAT AKUN BARU</button>
                    </div>

                    <div class="card">
                        <h3>üí∞ Modal Awal / Inject</h3>
                        <div class="grid-2" style="gap:10px;">
                            <div class="form-group"><input type="date" id="inject-date"></div>
                            <div class="form-group"><input type="text" id="inject-amount" placeholder="Rp" class="money-input" inputmode="numeric"></div>
                        </div>
                        <button class="btn" onclick="window.addCapitalInjection()">Tambah Modal</button>
                    </div>

                    <!-- KASBON OWNER CARD (V1.7.2) -->
                    <div class="card" style="border-color: var(--primary);">
                        <h3>üí∏ Input Kasbon Owner</h3>
                        <div class="form-group"><label>Pilih Owner</label><select id="kasbon-owner-select"></select></div>
                        <div class="form-group"><input type="date" id="kasbon-owner-date"></div>
                        <div class="form-group"><input type="text" id="kasbon-owner-amount" placeholder="Nominal Pinjaman (Rp)" class="money-input" inputmode="numeric"></div>
                        <div class="form-group"><input type="text" id="kasbon-owner-desc" placeholder="Keterangan (Opsional)"></div>
                        <button class="btn btn-warning" style="width:100%" onclick="window.saveOwnerKasBon()">SIMPAN KASBON OWNER</button>
                        <p style="font-size:0.75rem; color:#888; margin-top:5px;">*Kasbon akan otomatis dipotong saat proses Tutup Buku.</p>
                    </div>
                    
                    <!-- TABUNGAN CARD -->
                    <div class="card" style="border-color: var(--savings);">
                        <h3>üíé Tabungan & Koreksi</h3>
                        <div class="grid-2">
                            <div>
                                <div class="form-group"><label>Aksi</label><select id="saving-action-type"><option value="deposit">Setor</option><option value="withdraw">Tarik</option></select></div>
                                <div class="form-group"><input type="text" id="saving-manual-amount" class="money-input" inputmode="numeric"></div>
                                <button class="btn btn-info" style="width:100%" onclick="window.manualSavingsTransaction()">Proses</button>
                            </div>
                            <div style="border-left: 1px solid var(--border); padding-left: 20px;">
                                <h4 style="color: var(--danger)">Koreksi (Admin)</h4>
                                <div class="form-group"><input type="text" id="saving-correction-amount" placeholder="Nilai (bisa minus)" class="money-input" inputmode="numeric"></div>
                                <button class="btn btn-danger" style="width:100%" onclick="window.manualSavingsCorrection()">KOREKSI SALDO</button>
                            </div>
                        </div>
                        <div style="margin-top: 20px; text-align: center;">
                            <div class="stat-label">Saldo Tabungan</div>
                            <div class="stat-value" id="settings-savings-balance" style="color: var(--savings)">Rp 0</div>
                        </div>
                    </div>

                    <!-- DANA DARURAT CARD -->
                    <div class="card" style="border-color: var(--emergency);">
                        <h3>üö® Dana Darurat & Koreksi</h3>
                        <div class="grid-2">
                            <div>
                                <div class="form-group"><label>Aksi</label><select id="emergency-action-type"><option value="deposit">Setor</option><option value="withdraw">Tarik</option></select></div>
                                <div class="form-group"><input type="text" id="emergency-manual-amount" class="money-input" inputmode="numeric"></div>
                                <button class="btn btn-emergency" style="width:100%" onclick="window.manualEmergencyTransaction()">Proses</button>
                            </div>
                            <div style="border-left: 1px solid var(--border); padding-left: 20px;">
                                <h4 style="color: var(--danger)">Koreksi (Admin)</h4>
                                <div class="form-group"><input type="text" id="emergency-correction-amount" placeholder="Nilai (bisa minus)" class="money-input" inputmode="numeric"></div>
                                <button class="btn btn-danger" style="width:100%" onclick="window.manualEmergencyCorrection()">KOREKSI SALDO</button>
                            </div>
                        </div>
                        <div style="margin-top: 20px; text-align: center;">
                            <div class="stat-label">Saldo Dana Darurat</div>
                            <div class="stat-value stat-value-emergency" id="settings-emergency-balance">Rp 0</div>
                        </div>
                    </div>

                </div>

                <!-- ZONA BAHAYA CARD -->
                <div class="card danger-zone" style="margin-top: 30px; padding: 30px; text-align: center;">
                    <h3 style="color: var(--danger); margin-bottom: 10px;">‚ö†Ô∏è ZONA BAHAYA</h3>
                    <p style="margin-bottom: 20px; font-size: 0.9rem; color: #ccc;">Tindakan ini akan menghapus <strong>SELURUH DATA BISNIS</strong>.</p>
                    <button class="btn btn-danger" style="width: 100%; max-width: 300px;" onclick="window.initiateDataReset()">RESET DATA SELURUHNYA</button>
                </div>
            </section>

        </main>
    </div>

    <!-- MODAL INPUT KAS BON KARYAWAN -->
    <div id="kasbon-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="window.closeKasBonModal()">&times;</span>
            <h3 style="color: var(--primary); margin-bottom: 20px;">Input Kas Bon Karyawan</h3>
            <form onsubmit="window.saveKasBon(event)">
                <div class="form-group">
                    <label>Karyawan</label>
                    <select id="kb-employee" required>
                        <option value="">-- Pilih Karyawan --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Tanggal</label>
                    <input type="date" id="kb-date" required>
                </div>
                <div class="form-group">
                    <label>Nominal Pinjaman (Rp)</label>
                    <input type="text" id="kb-amount" class="money-input" inputmode="numeric" placeholder="0" required>
                </div>
                <div class="form-group">
                    <label>Keterangan (Opsional)</label>
                    <input type="text" id="kb-desc" placeholder="Contoh: Keperluan Mendesak">
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="button" class="btn btn-secondary" style="flex:1" onclick="window.closeKasBonModal()">Batal</button>
                    <button type="submit" class="btn" style="flex:1">Simpan Pinjaman</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL DETAIL GAJI -->
    <div id="payroll-detail-modal" class="modal">
        <div class="modal-content modal-lg">
            <span class="close-modal" onclick="window.closePayrollDetailModal()">&times;</span>
            <h3 style="color: var(--primary); margin-bottom: 5px;">Detail Rincian Gaji</h3>
            <div id="payroll-period-display" style="font-size: 0.9rem; color: #888; margin-bottom: 15px; border-bottom: 1px solid #444; padding-bottom: 10px;"></div>
            
            <div id="payroll-detail-content" style="font-size: 0.9rem; color: #ccc;"></div>
            
            <div style="margin-top: 20px; text-align: right;">
                <button class="btn btn-info" onclick="window.downloadPayrollSlip()">üì• Download Slip Gaji</button>
            </div>
        </div>
    </div>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <div id="loading-text">Memproses...</div>
    </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-analytics.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries
        
        // Added Firestore and Auth imports necessary for the app logic
        import { getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, addDoc, deleteDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, sendPasswordResetEmail, onAuthStateChanged, reauthenticateWithCredential, EmailAuthProvider } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

        // Your web app's Firebase configuration (UPDATED AS REQUESTED)
        const firebaseConfig = {
          apiKey: "AIzaSyDmJTS6f_3kdAaM97O8HGvQqOBeTL8V8z8",
          authDomain: "laporan-keuangan-8b07a.firebaseapp.com",
          databaseURL: "https://laporan-keuangan-8b07a-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "laporan-keuangan-8b07a",
          storageBucket: "laporan-keuangan-8b07a.firebasestorage.app",
          messagingSenderId: "306767849046",
          appId: "1:306767849046:web:9b5887e546e8616998bdf7",
          measurementId: "G-XSDPZ3GCJ1"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let appData = {
            products: [], employees: [], goods: [], transactions: [],
            reportHistory: [], payrollHistory: [],
            config: { 
                businessName: "GENTLEMEN'S CUT", 
                owners: [ 
                    { id: "1", name: "Owner 1", share: 50 },
                    { id: "2", name: "Owner 2", share: 50 }
                ],
                savings: 0,
                emergencySavings: 0
            }
        };
        let pendingReportData = null; 
        
        let currentUser = null, userRole = 'staff', editingProdId = null, editingEmpId = null, editingGoodId = null, editingTrxId = null, lastCalculatedPayroll = [], creatorEmail = '', creatorPass = '';
        
        // Pagination Variables
        let transactionPage = 1;
        const itemsPerPage = 50;

        // Chart Instances
        let chartIncomeInstance = null;
        let chartPieInstance = null;
        let chartBarbersInstance = null;

        // --- HELPER FUNCTIONS ---
        
        // Helper untuk parsing input uang (remove titik, jadi integer)
        function getVal(id) {
            const el = document.getElementById(id);
            if(!el) return 0;
            return parseInt((el.value || '0').replace(/\./g, '')) || 0;
        }

        // Helper format Rupiah untuk display
        function formatRupiah(n) { return 'Rp ' + parseInt(n || 0).toLocaleString('id-ID'); }
        function showToast(msg) { const x = document.getElementById("toast"); x.innerText = msg; x.className = "show"; setTimeout(() => { x.className = x.className.replace("show", ""); }, 3000); }
        function showLoading(show, text="Memproses...") { const el = document.getElementById('loading-overlay'); document.getElementById('loading-text').innerText = text; el.style.display = show ? 'flex' : 'none'; }
        function checkRole(roleNeeded = 'owner') { if (userRole !== roleNeeded) { showToast(`Akses Ditolak: Hanya ${roleNeeded === 'owner' ? 'Owner' : 'Staff'} yang boleh.`); return false; } return true; }
        
        // MODIFIKASI: Format Input Otomatis (410000 -> 410.000)
        function setupCurrencyInputs() {
            const inputs = document.querySelectorAll('.money-input');
            inputs.forEach(input => {
                input.addEventListener('input', (e) => {
                    let val = e.target.value.replace(/\D/g, ''); // Hapus semua non-digit
                    if (val) {
                        e.target.value = val.replace(/\B(?=(\d{3})+(?!\d))/g, "."); // Tambah titik ribuan
                    } else {
                        e.target.value = "";
                    }
                });
            });
        }

        function showSection(id) { 
            if((id === 'master-data' || id === 'gaji-karyawan' || id === 'laporan-keuangan' || id === 'pengaturan' || id === 'dashboard') && !checkRole('owner')) return; 
            
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active')); 
            document.getElementById(id).classList.add('active'); 
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active')); 
            
            if(window.innerWidth <= 768) {
                document.querySelector('aside').classList.remove('open');
            }
            
            if(window.event) {
                window.event.currentTarget.classList.add('active');
            } else {
                const btn = document.querySelector(`button[onclick*="showSection('${id}')"]`);
                if(btn) btn.classList.add('active');
            }
        }
        
        // --- AUTH ---
        async function handleLogin() {
            const btn = document.getElementById('btn-login');
            const originalText = btn.innerText;
            const email = document.getElementById('login-email').value, pass = document.getElementById('login-pass').value;
            if(!email || !pass) return showToast("Email dan Password wajib diisi");
            
            try {
                btn.innerText = "MEMPROSES...";
                btn.disabled = true;
                await signInWithEmailAndPassword(auth, email, pass);
                creatorEmail = email; creatorPass = pass;
            } catch (error) { showToast("Login Gagal: " + error.message); }
            finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }
        async function handleLogout() { creatorEmail = ''; creatorPass = ''; await signOut(auth); }
        async function registerNewUser() {
            const email = document.getElementById('new-user-email').value, pass = document.getElementById('new-user-pass').value, role = document.getElementById('new-user-role').value;
            if(!email || !pass) return showToast("Lengkapi data user baru");
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
                await setDoc(doc(db, "users", userCredential.user.uid), { email, role, createdAt: new Date().toISOString() });
                if(creatorEmail && creatorPass) { await signInWithEmailAndPassword(auth, creatorEmail, creatorPass); showToast("Akun dibuat!"); }
                else alert("Akun baru dibuat. Silakan logout & login ulang.");
                document.getElementById('new-user-email').value = ''; document.getElementById('new-user-pass').value = '';
            } catch (error) { showToast("Gagal: " + error.message); }
        }
        async function handleResetPassword() {
            const email = prompt("Masukkan email untuk reset password:");
            if(email) {
                try {
                    await sendPasswordResetEmail(auth, email);
                    showToast("Link reset password telah dikirim ke email.");
                } catch(e) { showToast("Error: " + e.message); }
            }
        }
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-content').classList.remove('hidden');
                document.getElementById('app-content').style.display = 'flex';
                document.getElementById('user-display-email').innerText = user.email;
                try {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (userDoc.exists()) userRole = userDoc.data().role;
                    else { userRole = 'owner'; await setDoc(doc(db, "users", user.uid), { email: user.email, role: 'owner', createdAt: new Date() }); }
                } catch(e) { userRole = 'staff'; }
                applyRoleRestrictions();
                fetchAllData();
            } else {
                currentUser = null; userRole = 'staff';
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('app-content').classList.add('hidden');
                document.getElementById('app-content').style.display = 'none';
            }
        });
        function applyRoleRestrictions() {
            const ownerMenu = document.querySelector('.owner-menu');
            const staffMenu = document.querySelector('.staff-menu');
            const navBtns = document.querySelectorAll('.nav-btn'); 
            
            if (userRole === 'owner') {
                ownerMenu.classList.remove('hidden');
                staffMenu.classList.add('hidden');
                if(navBtns[0]) navBtns[0].style.display = 'flex'; 
            } else {
                ownerMenu.classList.add('hidden');
                staffMenu.classList.add('hidden'); 
                if(navBtns[0]) navBtns[0].style.display = 'none';

                const activeSection = document.querySelector('.section.active');
                if (!activeSection || activeSection.id !== 'transaksi') {
                    showSection('transaksi');
                }
            }
        }

        // --- DATA ---
        async function fetchAllData() {
            try {
                const confDoc = await getDoc(doc(db, "config", "main_config"));
                if (confDoc.exists()) { 
                    appData.config = confDoc.data(); 
                    if(!appData.config.owners || !Array.isArray(appData.config.owners)) {
                        const o1 = appData.config.ownerNames?.owner1 || "Owner 1";
                        const o2 = appData.config.ownerNames?.owner2 || "Owner 2";
                        const s1 = appData.config.ownerShares?.owner1 || 50;
                        const s2 = appData.config.ownerShares?.owner2 || 50;
                        appData.config.owners = [
                            { id: "1", name: o1, share: s1 },
                            { id: "2", name: o2, share: s2 }
                        ];
                    }
                    if(appData.config.emergencySavings === undefined) appData.config.emergencySavings = 0;
                } else { 
                    if(appData.config.emergencySavings === undefined) appData.config.emergencySavings = 0;
                    await setDoc(doc(db, "config", "main_config"), appData.config); 
                }
                
                const prodSnap = await getDocs(query(collection(db, "products"), orderBy("name")));
                appData.products = prodSnap.docs.map(d => ({id: d.id, ...d.data()}));
                const empSnap = await getDocs(query(collection(db, "employees"), orderBy("name")));
                appData.employees = empSnap.docs.map(d => ({id: d.id, ...d.data()}));
                const goodSnap = await getDocs(query(collection(db, "goods"), orderBy("name")));
                appData.goods = goodSnap.docs.map(d => ({id: d.id, ...d.data()}));
                const trxSnap = await getDocs(query(collection(db, "transactions"), orderBy("date", "desc")));
                appData.transactions = trxSnap.docs.map(d => ({id: d.id, ...d.data()}));
                
                const paySnap = await getDocs(query(collection(db, "payrollHistory"), orderBy("id", "desc")));
                appData.payrollHistory = paySnap.docs.map(d => {
                    const data = d.data();
                    return { id: d.id, ...data }; 
                });
                
                const repSnap = await getDocs(query(collection(db, "reportHistory"), orderBy("id", "desc")));
                appData.reportHistory = repSnap.docs.map(d => {
                    const data = d.data();
                    return { id: d.id, ...data }; 
                });

                applyConfig(); refreshAllUI();
            } catch (error) { 
                console.error(error); 
                showToast("Error Loading Data"); 
            } finally {
                showLoading(false); 
            }
        }

        function refreshAllUI() {
            renderProductOptions(); renderProductTable(); 
            renderEmployeeOptions(); renderEmployeeTable();
            renderGoodOptions(); renderGoodTable();
            renderDashboard(); renderTransactionHistory(); updateBalances();
            renderOwnerSettings(); 
            renderOwnerKasbonSelect(); 
            setupCurrencyInputs(); // Init input formatting
        }

        // --- UPDATE BALANCES LOGIC ---
        function updateBalances() {
            // 1. Hitung Total Modal Masuk
            let totalModal = 0; 
            appData.transactions.forEach(t => {
                if (t.type === 'modal_in') totalModal += t.amount; 
            });
            document.getElementById('dash-cash').innerText = formatRupiah(totalModal);

            // 2. Update UI Tabungan & Darurat
            document.getElementById('dash-savings').innerText = formatRupiah(appData.config.savings);
            document.getElementById('dash-emergency').innerText = formatRupiah(appData.config.emergencySavings);
            document.getElementById('settings-savings-balance').innerText = formatRupiah(appData.config.savings);
            document.getElementById('settings-emergency-balance').innerText = formatRupiah(appData.config.emergencySavings);
        }

        // --- MASTER DATA ---
        async function saveProduct() { 
            if(!checkRole('owner')) return; 
            const btn = document.getElementById('btn-save-prod');
            const originalText = btn.innerText;
            const n=document.getElementById('prod-name').value, p=getVal('prod-price'); 
            if(!n||!p) return showToast("Lengkapi data"); 
            
            try { 
                btn.innerText = "MENYIMPAN...";
                btn.disabled = true;
                if(editingProdId) await updateDoc(doc(db, "products", editingProdId), { name: n, price: p }); else await addDoc(collection(db, "products"), { name:n, price:p }); 
                await fetchAllData(); resetProductForm(); 
            } catch(e) { showToast(e.message); }
            finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }
        function editProduct(id) { if(!checkRole('owner')) return; const p=appData.products.find(x=>x.id===id); document.getElementById('prod-name').value=p.name; document.getElementById('prod-price').value = p.price; editingProdId=id; document.getElementById('btn-save-prod').innerText="UPDATE"; }
        function resetProductForm() { document.getElementById('prod-name').value=''; document.getElementById('prod-price').value=''; editingProdId=null; document.getElementById('btn-save-prod').innerText="TAMBAH"; }
        async function deleteProduct(id) { if(!checkRole('owner')) return; if(confirm('Hapus?')) { await deleteDoc(doc(db, "products", id)); await fetchAllData(); } }
        function renderProductTable() { const tb=document.querySelector('#product-table tbody'); tb.innerHTML=''; appData.products.forEach(p=>tb.innerHTML+=`<tr><td>${p.name}</td><td>${formatRupiah(p.price)}</td><td><button class="btn btn-secondary" onclick="window.editProduct('${p.id}')">Edit</button> <button class="btn btn-danger" onclick="window.deleteProduct('${p.id}')">X</button></td></tr>`); }

        async function saveEmployee() { 
            if(!checkRole('owner')) return; 
            const btn = document.getElementById('btn-save-emp');
            const originalText = btn.innerText;
            const n=document.getElementById('emp-name').value, t=document.getElementById('emp-comm-type').value, v=getVal('emp-comm-value'); 
            if(!n||isNaN(v)) return showToast("Lengkapi data"); 
            
            try { 
                btn.innerText = "MENYIMPAN...";
                btn.disabled = true;
                if(editingEmpId) await updateDoc(doc(db, "employees", editingEmpId), { name: n, commissionType: t, commissionValue: v }); else await addDoc(collection(db, "employees"), { name:n, commissionType:t, commissionValue:v }); 
                await fetchAllData(); resetEmployeeForm(); 
            } catch(e) { showToast(e.message); }
            finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }
        function editEmployee(id) { if(!checkRole('owner')) return; const e=appData.employees.find(x=>x.id===id); document.getElementById('emp-name').value=e.name; document.getElementById('emp-comm-type').value=e.commissionType; document.getElementById('emp-comm-value').value=e.commissionValue; editingEmpId=id; document.getElementById('btn-save-emp').innerText="UPDATE"; }
        function resetEmployeeForm() { document.getElementById('emp-name').value=''; document.getElementById('emp-comm-value').value=''; editingEmpId=null; document.getElementById('btn-save-emp').innerText="TAMBAH"; }
        async function deleteEmployee(id) { if(!checkRole('owner')) return; if(confirm('Hapus?')) { await deleteDoc(doc(db, "employees", id)); await fetchAllData(); } }
        function renderEmployeeTable() { const tb=document.querySelector('#employee-table tbody'); tb.innerHTML=''; appData.employees.forEach(e=>{ let c=e.commissionType==='percent'?e.commissionValue+'%':formatRupiah(e.commissionValue); tb.innerHTML+=`<tr><td>${e.name}</td><td>${c}</td><td><button class="btn btn-secondary" onclick="window.editEmployee('${e.id}')">Edit</button> <button class="btn btn-danger" onclick="window.deleteEmployee('${e.id}')">X</button></td></tr>`; }); }
        function renderEmployeeOptions() { 
            const s=document.getElementById('trx-employee'); 
            s.innerHTML='<option value="">-- Pilih --</option>'; 
            appData.employees.forEach(e=>{ const o=document.createElement('option'); o.value=e.id; o.text=e.name; o.dataset.type=e.commissionType; o.dataset.value=e.commissionValue; s.appendChild(o); }); 
            
            const kb = document.getElementById('kb-employee');
            if(kb) {
                kb.innerHTML='<option value="">-- Pilih Karyawan --</option>'; 
                appData.employees.forEach(e=>{ const o=document.createElement('option'); o.value=e.id; o.text=e.name; kb.appendChild(o); });
            }
        }
        function showEmployeeCommInfo() { const s=document.getElementById('trx-employee'); const t=s.options[s.selectedIndex].dataset.type, v=s.options[s.selectedIndex].dataset.value; const h=document.getElementById('emp-comm-hint'); h.innerText = t?t==='percent'?`Komisi: ${v}%`:`Komisi: ${formatRupiah(v)}`:''; }
        function renderProductOptions() { const s=document.getElementById('trx-product'); s.innerHTML='<option value="">-- Pilih Layanan --</option>'; appData.products.forEach(p=>{ const o=document.createElement('option'); o.value=p.id; o.text=`${p.name} - ${formatRupiah(p.price)}`; o.dataset.price=p.price; s.appendChild(o); }); }

        async function saveGood() { 
            if(!checkRole('owner')) return; 
            const btn = document.getElementById('btn-save-good');
            const originalText = btn.innerText;
            const n=document.getElementById('good-name').value, p=getVal('good-price'), s=parseInt(document.getElementById('good-stock').value); 
            if(!n || isNaN(p) || isNaN(s)) return showToast("Lengkapi data"); 
            
            try { 
                btn.innerText = "MENYIMPAN...";
                btn.disabled = true;
                if(editingGoodId) await updateDoc(doc(db, "goods", editingGoodId), { name: n, price: p, stock: s }); else await addDoc(collection(db, "goods"), { name:n, price:p, stock:s }); 
                await fetchAllData(); resetGoodForm(); 
            } catch(e) { showToast(e.message); }
            finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }
        function editGood(id) { if(!checkRole('owner')) return; const g=appData.goods.find(x=>x.id===id); document.getElementById('good-name').value=g.name; document.getElementById('good-price').value=g.price; document.getElementById('good-stock').value=g.stock; editingGoodId=id; document.getElementById('btn-save-good').innerText="UPDATE"; }
        function resetGoodForm() { document.getElementById('good-name').value=''; document.getElementById('good-price').value=''; document.getElementById('good-stock').value=''; editingGoodId=null; document.getElementById('btn-save-good').innerText="TAMBAH/UPDATE"; }
        async function deleteGood(id) { if(!checkRole('owner')) return; if(confirm('Hapus?')) { await deleteDoc(doc(db, "goods", id)); await fetchAllData(); } }
        function renderGoodTable() { const tb=document.querySelector('#good-table tbody'); tb.innerHTML=''; appData.goods.forEach(g=>tb.innerHTML+=`<tr><td>${g.name}</td><td>${formatRupiah(g.price)}</td><td style="color:${g.stock < 5 ? 'var(--danger)' : 'var(--success)'}">${g.stock}</td><td><button class="btn btn-secondary" onclick="window.editGood('${g.id}')">Edit</button> <button class="btn btn-danger" onclick="window.deleteGood('${g.id}')">X</button></td></tr>`); }
        function renderGoodOptions() { const s=document.getElementById('trx-good'); s.innerHTML='<option value="">-- Pilih Barang --</option>'; appData.goods.forEach(g=>{ const o=document.createElement('option'); o.value=g.id; o.text=`${g.name} (Stok: ${g.stock})`; o.dataset.price=g.price; o.dataset.stock=g.stock; s.appendChild(o); }); }

        // --- TRANSAKSI ---
        function toggleTransactionFields() { const type = document.getElementById('trx-type').value; document.getElementById('income-fields').style.display = type === 'income' ? 'block' : 'none'; document.getElementById('expense-fields').style.display = type === 'expense' ? 'block' : 'none'; }
        function toggleCategoryFields() { const cat = document.getElementById('trx-category').value; document.getElementById('service-specific').style.display = cat === 'service' ? 'block' : 'none'; document.getElementById('good-specific').style.display = cat === 'good' ? 'block' : 'none'; document.getElementById('trx-price').value = ''; document.getElementById('trx-amount').value = ''; }
        function autoFillPrice() { const s=document.getElementById('trx-product'); const price = s.options[s.selectedIndex].dataset.price || 0; document.getElementById('trx-price').value = price; updateTotalPrice(); }
        function autoFillPriceGood() { const s=document.getElementById('trx-good'); const stock = s.options[s.selectedIndex].dataset.stock || 0; document.getElementById('stock-display').innerText = stock; const price = s.options[s.selectedIndex].dataset.price || 0; document.getElementById('trx-price').value = price; updateTotalPrice(); }
        function updateTotalPrice() { const price = parseInt(document.getElementById('trx-price').value) || 0; const qty = parseFloat(document.getElementById('trx-qty').value) || 1; document.getElementById('trx-amount').value = (price * qty).toLocaleString('id-ID'); }
        
        async function handleTransactionSubmit(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-save-trx');
            const originalText = btn.innerText;
            const type = document.getElementById('trx-type').value, date = document.getElementById('trx-date').value, qty = parseInt(document.getElementById('trx-qty').value) || 1, amount = getVal('trx-amount'); 
            let details = {}, comm = 0;
            if(type === 'income') {
                const category = document.getElementById('trx-category').value;
                if(category === 'service') {
                    const empId = document.getElementById('trx-employee').value, prodId = document.getElementById('trx-product').value;
                    if(!empId || !prodId) return showToast("Pilih Karyawan dan Layanan");
                    const emp = appData.employees.find(x=>x.id===empId);
                    if(emp) { if(emp.commissionType === 'percent') comm = Math.floor((amount / qty) * (emp.commissionValue/100)) * qty; else comm = emp.commissionValue * qty; }
                    details = { category: 'service', employeeId: empId, productId: prodId, commission: comm, qty: qty, productName: appData.products.find(p=>p.id===prodId)?.name };
                } else {
                    const goodId = document.getElementById('trx-good').value; if(!goodId) return showToast("Pilih Barang");
                    const good = appData.goods.find(g => g.id === goodId);
                    if(good.stock < qty) return showToast(`Stok tidak cukup! Tersisa: ${good.stock}`);
                    const newStock = good.stock - qty; await updateDoc(doc(db, "goods", goodId), { stock: newStock });
                    details = { category: 'good', goodId: goodId, qty: qty, stockBefore: good.stock, productName: good.name };
                }
            } else { const desc = document.getElementById('trx-desc').value; if(!desc) return showToast("Isi keterangan"); details = { description: desc }; }
            
            try { 
                btn.innerText = "MENYIMPAN...";
                btn.disabled = true;
                if(editingTrxId) { if(!checkRole('owner')) return; await updateDoc(doc(db, "transactions", editingTrxId), { date, type, amount, details }); } else await addDoc(collection(db, "transactions"), { date, type, amount, details }); 
                await fetchAllData(); resetTransactionForm(); 
            } catch(err) { showToast(err.message); }
            finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }
        function editTransaction(id) { if(!checkRole('owner')) return; const t = appData.transactions.find(x => x.id === id); if(!t) return; editingTrxId = id; document.getElementById('trx-date').value = t.date; document.getElementById('trx-type').value = t.type; toggleTransactionFields(); if(t.type === 'income') { const cat = t.details.category || 'service'; document.getElementById('trx-category').value = cat; toggleCategoryFields(); if(cat === 'service') { document.getElementById('trx-employee').value = t.details.employeeId; document.getElementById('trx-product').value = t.details.productId; document.getElementById('trx-qty').value = t.details.qty || 1; document.getElementById('trx-amount').value = t.amount; autoFillPrice(); } else { document.getElementById('trx-good').value = t.details.goodId; document.getElementById('trx-qty').value = t.details.qty || 1; document.getElementById('trx-amount').value = t.amount; autoFillPriceGood(); } } else { document.getElementById('trx-desc').value = t.details.description; document.getElementById('trx-amount').value = t.amount; } document.getElementById('btn-save-trx').innerText = "UPDATE"; document.getElementById('btn-cancel-trx').style.display = 'block'; }
        function resetTransactionForm() { editingTrxId = null; document.getElementById('trx-date').value = new Date().toISOString().split('T')[0]; document.getElementById('trx-qty').value = 1; document.getElementById('trx-amount').value = ''; document.getElementById('trx-price').value = ''; document.getElementById('trx-desc').value = ''; document.getElementById('trx-category').value = 'service'; toggleCategoryFields(); document.getElementById('btn-save-trx').innerText = "SIMPAN TRANSAKSI"; document.getElementById('btn-cancel-trx').style.display = 'none'; }
        async function voidTransaction(id) { 
            if(!checkRole('owner')) return; 
            if(!confirm("Batalkan transaksi ini?")) return; 
            
            const t = appData.transactions.find(x => x.id === id); 
            if(!t) return; 
            
            if (t.type === 'income' && t.details.category === 'good' && t.details.goodId && !t.details.isVoid) {
                const good = appData.goods.find(g => g.id === t.details.goodId);
                if (good) {
                    const qty = t.details.qty ||1;
                    await updateDoc(doc(db, "goods", good.id), { stock: good.stock + qty });
                }
            }

            try { 
                const updatedDetails = { ...t.details }; 
                updatedDetails.isVoid = true; 
                if(t.type === 'income') { 
                    updatedDetails.originalAmount = t.amount; 
                    if(t.details.category === 'service') { 
                        updatedDetails.originalCommission = t.details.commission || 0; 
                        updatedDetails.commission = 0; 
                        updatedDetails.description = `${t.details.productName} (VOID)`; 
                    } else { 
                        updatedDetails.description = `${t.details.productName} (VOID)`; 
                    } 
                } else { 
                    updatedDetails.originalAmount = t.amount; 
                    updatedDetails.description = `${t.details.description} (VOID)`; 
                } 
                await updateDoc(doc(db, "transactions", id), { amount: 0, details: updatedDetails }); 
                await fetchAllData(); 
                showToast("Transaksi dibatalkan & Stok dikembalikan"); 
            } catch(err) { showToast(err.message); } 
        }
        
        function resetTransactionPagination() {
            transactionPage = 1;
            document.getElementById('btn-load-more-trx').style.display = 'block';
            renderTransactionHistory();
        }
        function loadMoreTransactions() {
            transactionPage++;
            renderTransactionHistory();
        }
        
        function renderTransactionHistory() { 
            const startInput = document.getElementById('trx-history-start').value, endInput = document.getElementById('trx-history-end').value; 
            let filtered = []; 
            if(!startInput && !endInput) { 
                const today = new Date().toISOString().split('T')[0]; 
                filtered = appData.transactions.filter(t => t.date === today); 
                document.getElementById('trx-history-start').value = today; 
                document.getElementById('trx-history-end').value = today; 
            } else { 
                const start = startInput || '1970-01-01', end = endInput || '2099-12-31'; 
                filtered = appData.transactions.filter(t => t.date >= start && t.date <= end); 
            } 
            
            const startIdx = 0;
            const endIdx = transactionPage * itemsPerPage;
            const paginatedFiltered = filtered.slice(startIdx, endIdx);

            const tb = document.querySelector('#today-trx-table tbody'); 
            tb.innerHTML=''; 
            paginatedFiltered.forEach(t => { 
                const isVoid = t.amount === 0 && (t.details.isVoid || (t.details.description && t.details.description.includes("VOID"))); 
                let info = '-'; 
                if(t.type === 'kas_bon') {
                    const emp = appData.employees.find(e=>e.id===t.details.employeeId)?.name || 'Unknown';
                    info = `üí∏ Kas Bon<br><small>to: ${emp}</small>`;
                } else if(t.type === 'owner_kasbon') { 
                    const owner = appData.config.owners.find(o=>o.id===t.details.ownerId)?.name || 'Unknown';
                    info = `üí∏ Kasbon Owner<br><small>to: ${owner}</small>`;
                } else if(t.type === 'income') { 
                    if(t.details.category === 'good') info = `üì¶ ${t.details.productName}`; 
                    else { 
                        const prod = appData.products.find(p=>p.id===t.details.productId)?.name; 
                        const emp = appData.employees.find(e=>e.id===t.details.employeeId)?.name || '-'; 
                        info = `‚úÇÔ∏è ${prod}<br><small>by: ${emp}</small>`; 
                    } 
                } else { 
                    info = t.details.description; 
                } 
                let qty = (t.type === 'income') ? t.details.qty : '-'; 
                let totalDisplay = isVoid ? "Rp 0 (Void)" : formatRupiah(t.amount); 
                let rowClass = isVoid ? 'voided-row' : ''; 
                let actionBtns = ''; 
                
                // MODIFIKASI LABEL RIWAYAT TRANSAKSI
                let typeLabel = '';
                let badgeClass = '';

                if (t.type === 'kas_bon') {
                    typeLabel = 'KAS BON';
                    badgeClass = 'badge-locked';
                } else if (t.type === 'owner_kasbon') {
                    typeLabel = 'KASBON OWNER';
                    badgeClass = 'badge-locked';
                } else if (t.type === 'income') {
                    typeLabel = 'Pemasukan'; // Sesuai permintaan
                    badgeClass = 'badge-in';
                } else {
                    typeLabel = 'Pengeluaran'; // Sesuai permintaan
                    badgeClass = 'badge-out';
                }
                
                if(userRole === 'owner') { 
                    if(!isVoid && t.type !== 'kas_bon' && t.type !== 'owner_kasbon') { 
                        actionBtns = `<button class="btn btn-warning" style="font-size:0.7rem;" onclick="window.editTransaction('${t.id}')">Edit</button> <button class="btn btn-danger" style="font-size:0.7rem;" onclick="window.voidTransaction('${t.id}')">Batal</button>`; 
                    } else if (!isVoid && (t.type === 'kas_bon' || t.type === 'owner_kasbon')) {
                         actionBtns = `<button class="btn btn-danger" style="font-size:0.7rem;" onclick="window.voidTransaction('${t.id}')">Batal</button>`; 
                    } else {
                        actionBtns = `<span class="badge badge-void">Batal</span>`; 
                    }
                } 
                tb.innerHTML += `<tr class="${rowClass}"><td><span class="badge ${badgeClass}">${typeLabel}</span></td><td>${info}</td><td style="text-align:center">${qty}</td><td>${totalDisplay}</td><td>${actionBtns}</td></tr>`; 
            }); 

            if(endIdx >= filtered.length) {
                document.getElementById('btn-load-more-trx').style.display = 'none';
            }
        }
        
        function renderDashboard() { 
            initCharts();
            
            const n=new Date(); 
            const m=appData.transactions.filter(t=>{ const d=new Date(t.date); return d.getMonth()===n.getMonth() && d.getFullYear()===n.getFullYear(); }); 
            document.getElementById('dash-income').innerText = formatRupiah(m.filter(t=>t.type==='income').reduce((a,b)=>a+b.amount,0)); 
            document.getElementById('dash-expense').innerText = formatRupiah(m.filter(t=>t.type==='expense').reduce((a,b)=>a+b.amount,0)); 
        }

        // --- KAS BON LOGIC ---
        function openKasBonModal() {
            if(!checkRole('owner')) return;
            document.getElementById('kb-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('kasbon-modal').style.display = 'flex';
        }
        function closeKasBonModal() {
            document.getElementById('kasbon-modal').style.display = 'none';
            document.getElementById('kb-amount').value = '';
            document.getElementById('kb-desc').value = '';
            document.getElementById('kb-employee').value = '';
        }
        async function saveKasBon(e) {
            e.preventDefault();
            if(!checkRole('owner')) return;
            
            const empId = document.getElementById('kb-employee').value;
            const date = document.getElementById('kb-date').value;
            const amount = getVal('kb-amount'); 
            const desc = document.getElementById('kb-desc').value;

            if(!empId || !amount) return showToast("Lengkapi data kas bon");

            try {
                await addDoc(collection(db, "transactions"), {
                    date,
                    type: 'kas_bon',
                    amount: amount,
                    details: {
                        employeeId: empId,
                        description: desc || 'Pinjaman Kas Bon'
                    }
                });
                showToast("Kas Bon berhasil disimpan.");
                closeKasBonModal();
                await fetchAllData();
            } catch(err) {
                showToast("Gagal: " + err.message);
            }
        }

        // --- OWNER KAS BON LOGIC (V1.7.2) ---
        function renderOwnerKasbonSelect() {
            const select = document.getElementById('kasbon-owner-select');
            if(!select) return;
            select.innerHTML = '';
            appData.config.owners.forEach(o => {
                const opt = document.createElement('option');
                opt.value = o.id;
                opt.text = o.name;
                select.appendChild(opt);
            });
            document.getElementById('kasbon-owner-date').value = new Date().toISOString().split('T')[0];
        }

        async function saveOwnerKasBon() {
            if(!checkRole('owner')) return;
            const ownerId = document.getElementById('kasbon-owner-select').value;
            const date = document.getElementById('kasbon-owner-date').value;
            const amount = getVal('kasbon-owner-amount'); 
            const desc = document.getElementById('kasbon-owner-desc').value;

            if(!ownerId || !amount) return showToast("Lengkapi data kasbon owner");

            try {
                await addDoc(collection(db, "transactions"), {
                    date,
                    type: 'owner_kasbon',
                    amount: amount,
                    details: {
                        ownerId: ownerId,
                        description: desc || 'Pinjaman Owner'
                    }
                });
                showToast("Kasbon Owner berhasil disimpan.");
                document.getElementById('kasbon-owner-amount').value = '';
                document.getElementById('kasbon-owner-desc').value = '';
                await fetchAllData();
            } catch(err) {
                showToast("Gagal: " + err.message);
            }
        }

        // --- PAYROLL ---
        function switchPayrollTab(tab) { document.querySelectorAll('#gaji-karyawan .tab').forEach(t=>t.classList.remove('active')); event.currentTarget.classList.add('active'); document.querySelectorAll('#gaji-karyawan .tab-content').forEach(c=>c.style.display='none'); document.getElementById('tab-pay-'+tab).style.display='block'; if(tab==='history') renderPayrollHistory(); }
        
        function calculatePayroll() { 
            if(!checkRole('owner')) return; 
            const start = document.getElementById('pay-start').value, end = document.getElementById('pay-end').value; 
            if(!start || !end) return showToast("Pilih rentang tanggal"); 
            
            const existingPeriod = appData.payrollHistory.find(h => h.periodStart === start && h.periodEnd === end);
            const btnSave = document.getElementById('btn-save-payroll');
            
            if(existingPeriod) {
                btnSave.disabled = true;
                btnSave.innerText = "Gaji Periode Ini Tersimpan";
                showToast("Periode ini sudah terkunci di riwayat.");
            } else {
                btnSave.disabled = false;
                btnSave.innerText = "Simpan & Kunci Riwayat";
            }

            const periodTrx = appData.transactions.filter(t => t.type === 'income' && (t.details?.category === 'service' || !t.details?.category) && t.date >= start && t.date <= end && t.amount > 0); 
            const empData = {}; 
            periodTrx.forEach(t => { 
                const eid = t.details.employeeId, pid = t.details.productId, prod = appData.products.find(p=>p.id===pid), prodName = prod ? prod.name : 'Unknown', qty = t.details.qty || 1; 
                if(!empData[eid]) empData[eid] = { totalQty:0, totalOmset:0, totalComm:0, details: {} }; 
                empData[eid].totalQty += qty; 
                empData[eid].totalOmset += t.amount; 
                empData[eid].totalComm += t.details.commission; 
                if(!empData[eid].details[prodName]) empData[eid].details[prodName] = 0; 
                empData[eid].details[prodName] += qty; 
            }); 
            
            lastCalculatedPayroll = []; 
            const tb = document.querySelector('#payroll-table tbody'); 
            tb.innerHTML=''; 
            
            appData.employees.forEach(e => { 
                if(empData[e.id]) { 
                    const d = empData[e.id]; 
                    
                    const kasBonTrx = appData.transactions.filter(t => 
                        t.type === 'kas_bon' && 
                        t.details.employeeId === e.id && 
                        t.date >= start && 
                        t.date <= end
                    );
                    const totalKasBon = kasBonTrx.reduce((sum, t) => sum + t.amount, 0);
                    
                    lastCalculatedPayroll.push({ 
                        empId: e.id, 
                        empName: e.name, 
                        totalQty: d.totalQty, 
                        totalOmset: d.totalOmset, 
                        totalComm: d.totalComm, 
                        bonus: 0, 
                        kasBon: totalKasBon,
                        totalFinal: d.totalComm - totalKasBon, 
                        detailRaw: d.details 
                    }); 
                    
                    const index = lastCalculatedPayroll.length - 1;
                    
                    tb.innerHTML += `
                        <tr>
                            <td style="font-weight:bold">${e.name}</td>
                            <td style="text-align:center">${d.totalQty}</td>
                            <td>${formatRupiah(d.totalOmset)}</td>
                            <td style="text-align:right">
                                <input type="text" class="money-input bonus-input" data-index="${index}" 
                                       value="0" placeholder="0" inputmode="numeric"
                                       style="width:100px; padding:4px; background:#333; border:1px solid #555; color:white; font-size:0.85rem; text-align:right;">
                            </td>
                            <td style="text-align:right; color:var(--text-main); font-weight:bold;" id="gross-sal-${index}">${formatRupiah(d.totalComm)}</td>
                            <td style="text-align:right; color:var(--danger);">${formatRupiah(totalKasBon)}</td>
                            <td style="color:var(--success); font-weight:bold; text-align:right">${formatRupiah(d.totalComm - totalKasBon)}</td>
                            <td style="text-align:center;"><button class="btn btn-secondary btn-sm" title="Lihat Detail" onclick="window.showPayrollDetail(null, ${index})">üëÅÔ∏è</button></td>
                        </tr>`; 
                } 
            }); 
            if(tb.innerHTML === '') tb.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:20px;">Tidak ada data layanan.</td></tr>';
            
            // Re-attach formatter to new inputs
            setupCurrencyInputs();
        }
        
        document.addEventListener('input', function(e) {
            if(e.target.classList.contains('bonus-input')) {
                const index = e.target.dataset.index;
                const bonus = getVal(null, e.target.value); // Special getVal for element
                if(lastCalculatedPayroll[index]) {
                    lastCalculatedPayroll[index].bonus = bonus;
                    lastCalculatedPayroll[index].totalFinal = lastCalculatedPayroll[index].totalComm + bonus - lastCalculatedPayroll[index].kasBon;
                    
                    const row = e.target.closest('tr');
                    const grossCell = row.cells[4]; 
                    const totalCell = row.cells[6];
                    if(grossCell) grossCell.innerText = formatRupiah(lastCalculatedPayroll[index].totalComm + bonus);
                    if(totalCell) totalCell.innerText = formatRupiah(lastCalculatedPayroll[index].totalFinal);
                }
            }
        });
        
        async function savePayrollHistory() { 
            if(!checkRole('owner')) return; 
            if(lastCalculatedPayroll.length === 0) return showToast("Hitung gaji dulu."); 
            
            const start = document.getElementById('pay-start').value;
            const end = document.getElementById('pay-end').value;
            
            const btn = document.getElementById('btn-save-payroll');
            const originalText = btn.innerText;

            try {
                btn.innerText = "MENYIMPAN...";
                btn.disabled = true;

                const recordsWithStatus = lastCalculatedPayroll.map(r => ({
                    ...r,
                    isPaid: false,
                    paidDate: ''
                }));

                const totalSalary = recordsWithStatus.reduce((sum, item) => sum + item.totalComm + item.bonus, 0);
                const totalPureCommission = recordsWithStatus.reduce((sum, item) => sum + item.totalComm, 0);
                const salaryDifference = totalSalary - totalPureCommission;

                if(salaryDifference > 0) {
                    await addDoc(collection(db, "transactions"), { 
                        date: new Date().toISOString().split('T')[0], 
                        type: 'expense', 
                        amount: salaryDifference, 
                        details: { description: 'Pembayaran Bonus/Tunjangan Karyawan' } 
                    });
                    showToast("Gaji disimpan. Bonus dicatat di pengeluaran.");
                } else {
                    showToast("Gaji Dikunci.");
                }

                const docRef = await addDoc(collection(db, "payrollHistory"), { 
                    periodStart: start, 
                    periodEnd: end, 
                    records: recordsWithStatus, 
                    timestamp: new Date().toLocaleString() 
                });
                await updateDoc(docRef, { id: docRef.id });
                await fetchAllData(); 
                renderPayrollHistory(); 
            } catch(e) {
                showToast(e.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        function renderPayrollHistory() { 
            if(!checkRole('owner')) return; 
            const tb = document.querySelector('#payroll-history-table tbody'); 
            tb.innerHTML=''; 
            if (appData.payrollHistory.length === 0) {
                tb.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:20px;">Belum ada riwayat gaji.</td></tr>';
                return;
            }
            
            const sortedHistory = [...appData.payrollHistory].sort((a,b) => (a.periodStart < b.periodStart ? 1 : -1));

            sortedHistory.forEach((h, hIdx) => { 
                if(h.records && Array.isArray(h.records)) {
                    h.records.forEach((r, rIdx) => { 
                        const bonus = r.bonus || 0;
                        const kasBon = r.kasBon || 0;
                        const total = r.totalComm + bonus;
                        
                        const isPaid = r.isPaid || false;
                        const statusBadge = isPaid 
                            ? `<span class="badge badge-paid">LUNAS</span>` 
                            : `<span class="badge badge-unpaid">BELUM</span>`;
                        
                        const statusBtn = isPaid
                            ? `<button class="btn btn-secondary btn-sm" onclick="window.updatePaymentStatus('${h.id}', ${rIdx}, false, '${r.empName}')" title="Tandai Belum Lunas">Reset</button>`
                            : `<button class="btn btn-success btn-sm" onclick="window.updatePaymentStatus('${h.id}', ${rIdx}, true, '${r.empName}')" title="Tandai Lunas">Lunas</button>`;

                        tb.innerHTML += `
                            <tr>
                                <td>${h.periodStart} <br><small>${h.periodEnd}</small></td>
                                <td><b>${r.empName}</b></td>
                                <td style="text-align:center">${r.totalQty}</td>
                                <td style="text-align:right">${formatRupiah(total - kasBon)}</td>
                                <td style="text-align:center">${statusBadge}</td>
                                <td style="text-align:center; font-size:0.85rem;">${r.paidDate || '-'}</td>
                                <td><button class="btn btn-secondary btn-sm" onclick="window.showPayrollDetail('${h.id}', ${rIdx})">Lihat Detail</button></td>
                                <td>${statusBtn} <button class="btn btn-danger btn-sm" onclick="window.editPayrollHistory('${h.id}')" title="Buka Kunci/Unlock">üîì</button></td>
                            </tr>
                        `; 
                    });
                }
            });
        }
        
        async function updatePaymentStatus(historyId, recordIndex, newStatus, empName) {
            if(!checkRole('owner')) return;
            
            let paidDate = '';
            if(newStatus) {
                paidDate = prompt(`Masukkan tanggal pembayaran untuk ${empName} (YYYY-MM-DD):`, new Date().toISOString().split('T')[0]);
                if(!paidDate) return;
            }

            try {
                const historyDoc = appData.payrollHistory.find(h => h.id === historyId);
                if(historyDoc && historyDoc.records[recordIndex]) {
                    historyDoc.records[recordIndex].isPaid = newStatus;
                    historyDoc.records[recordIndex].paidDate = paidDate;
                    
                    await updateDoc(doc(db, "payrollHistory", historyId), {
                        records: historyDoc.records
                    });
                    showToast("Status pembayaran diupdate.");
                    await fetchAllData();
                    renderPayrollHistory();
                }
            } catch(e) {
                showToast("Gagal update: " + e.message);
            }
        }

        let currentSlipHistory = null;
        let currentSlipRecord = null;

        function showPayrollDetail(historyId, recordIndex) {
            if(historyId === null) {
                currentSlipHistory = null;
                currentSlipRecord = lastCalculatedPayroll[recordIndex];
                const start = document.getElementById('pay-start').value;
                const end = document.getElementById('pay-end').value;
                document.getElementById('payroll-period-display').innerText = `Periode: ${start} s/d ${end}`;
            } else {
                const history = appData.payrollHistory.find(h => h.id === historyId);
                if(!history) return;
                currentSlipHistory = history;
                currentSlipRecord = history.records[recordIndex];
                document.getElementById('payroll-period-display').innerText = `Periode: ${history.periodStart} s/d ${history.periodEnd}`;
            }
            
            if(!currentSlipRecord) return;

            const r = currentSlipRecord;
            
            let start, end;
            if(currentSlipHistory) {
                start = currentSlipHistory.periodStart;
                end = currentSlipHistory.periodEnd;
            } else {
                start = document.getElementById('pay-start').value;
                end = document.getElementById('pay-end').value;
            }

            const kasBonList = appData.transactions.filter(t => 
                t.type === 'kas_bon' && 
                t.details.employeeId === r.empId && 
                t.date >= start && 
                t.date <= end
            );

            let html = `
                <div style="background:#222; padding:15px; border-radius:8px; margin-bottom:15px;">
                    <p style="font-size:1.1rem; margin-bottom:5px;">${r.empName}</p>
                    <p>Total Pelanggan: <b>${r.totalQty}</b></p>
                    <p>Gaji Kotor (Komisi+Bonus): <b style="color:var(--primary)">${formatRupiah(r.totalComm + r.bonus)}</b></p>
                    <p>Potongan Kas Bon: <span style="color:var(--danger)">-${formatRupiah(r.kasBon)}</span></p>
                    <hr style="border-color:#444; margin:10px 0;">
                    <p style="font-size:1.2rem;">Total Diterima: <b style="color:var(--success)">${formatRupiah(r.totalFinal)}</b></p>
                </div>
                <h5 style="color:var(--primary); border-bottom:1px solid #444; padding-bottom:5px; margin-bottom:10px;">Rincian Layanan</h5>
                <div style="max-height:200px; overflow-y:auto;">
            `;
            
            if(r.detailRaw) {
                for(let [name, count] of Object.entries(r.detailRaw)) {
                    html += `<div style="display:flex; justify-content:space-between; font-size:0.9rem; margin-bottom:5px;"><span>${name}</span><span>${count}x</span></div>`;
                }
            } else {
                html += `<div style="color:#888;">Data detail layanan tidak tersedia (data lama).</div>`;
            }

            html += `</div>`;
            
            if(kasBonList.length > 0) {
                html += `
                    <h5 style="color:var(--danger); border-bottom:1px solid #444; padding-bottom:5px; margin-top:20px; margin-bottom:10px;">Riwayat Kas Bon Periode Ini</h5>
                    <ul style="padding-left:20px; color:#ccc;">
                `;
                kasBonList.forEach(kb => {
                    html += `<li style="margin-bottom:5px;">${kb.date}: <b>${formatRupiah(kb.amount)}</b> (${kb.details.description || '-'})</li>`;
                });
                html += `</ul>`;
            } else {
                html += `<p style="color:#888; margin-top:10px;">Tidak ada riwayat kas bon pada periode ini.</p>`;
            }

            document.getElementById('payroll-detail-content').innerHTML = html;
            document.getElementById('payroll-detail-modal').style.display = 'flex';
        }

        function closePayrollDetailModal() {
            document.getElementById('payroll-detail-modal').style.display = 'none';
        }

        function downloadPayrollSlip() {
            if(!currentSlipRecord) return;

            const r = currentSlipRecord;
            const period = document.getElementById('payroll-period-display').innerText;

            const slipContent = `
            <!DOCTYPE html>
            <html>
            <head>
                <title>Slip Gaji - ${r.empName}</title>
                <style>
                    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 40px; background: #f4f4f4; }
                    .slip-card { background: white; max-width: 600px; margin: 0 auto; padding: 30px; border: 1px solid #ccc; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
                    .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #d4af37; padding-bottom: 20px; }
                    .header h1 { margin: 0; color: #333; }
                    .header p { color: #666; margin: 5px 0; }
                    .row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 16px; }
                    .row span:first-child { color: #555; }
                    .row span:last-child { font-weight: bold; }
                    .total-row { margin-top: 20px; padding-top: 20px; border-top: 2px solid #333; font-size: 18px; color: #d4af37; }
                    .footer { margin-top: 30px; text-align: center; font-size: 12px; color: #999; }
                </style>
            </head>
            <body>
                <div class="slip-card">
                    <div class="header">
                        <h1>${appData.config.businessName || "BARBERSHOP"}</h1>
                        <h2>SLIP GAJI</h2>
                        <p>${period}</p>
                    </div>
                    <div class="row"><span>Nama Karyawan:</span> <span>${r.empName}</span></div>
                    <div class="row"><span>Total Pelanggan:</span> <span>${r.totalQty}</span></div>
                    <div class="row"><span>Komisi:</span> <span>${formatRupiah(r.totalComm)}</span></div>
                    <div class="row"><span>Bonus/Tunjangan:</span> <span>${formatRupiah(r.bonus || 0)}</span></div>
                    <div class="row"><span>Potongan Kas Bon:</span> <span>- ${formatRupiah(r.kasBon)}</span></div>
                    <div class="row total-row">
                        <span>TOTAL DITERIMA:</span>
                        <span>${formatRupiah(r.totalFinal)}</span>
                    </div>
                    <div class="footer">
                        <p>Slip ini dibuat secara otomatis oleh sistem.</p>
                    </div>
                </div>
            </body>
            </html>
            `;

            const blob = new Blob([slipContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Slip_Gaji_${r.empName}_${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function editPayrollHistory(id) { if(!checkRole('owner')) return; if(confirm('Buka kunci ini? Data akan dihapus dari riwayat.')) { await deleteDoc(doc(db, "payrollHistory", id)); await fetchAllData(); showToast("Riwayat dihapus"); } }

        // --- REPORT & SETTINGS ---
        function renderOwnerSettings() {
            const container = document.getElementById('owner-settings-container');
            container.innerHTML = '';
            appData.config.owners.forEach((owner, index) => {
                const div = document.createElement('div');
                div.className = 'owner-input-row';
                div.innerHTML = `
                    <input type="text" placeholder="Nama Owner" value="${owner.name}" id="owner-name-${index}" style="flex:2">
                    <input type="number" placeholder="%" value="${owner.share}" id="owner-share-${index}" style="flex:1" oninput="window.updateOwnerTotalPct()">
                    <button class="btn btn-danger btn-sm" onclick="window.removeOwnerConfig(${index})">X</button>
                `;
                container.appendChild(div);
            });
            document.getElementById('conf-business-name').value = appData.config.businessName || "Barbershop";
            document.getElementById('brand-name').innerText = appData.config.businessName || "BARBERSHOP MANAGER";
            document.getElementById('print-business-name').innerText = appData.config.businessName || "LAPORAN KEUANGAN";
        }
        function addOwnerConfig() { appData.config.owners.push({ id: Date.now().toString(), name: `Owner ${appData.config.owners.length +1}`, share: 0 }); renderOwnerSettings(); }
        function removeOwnerConfig(index) { if(confirm("Hapus owner ini?")) { appData.config.owners.splice(index,1); renderOwnerSettings(); } }
        function updateOwnerTotalPct() { let total = 0; appData.config.owners.forEach((owner, index) => { const input = document.getElementById(`owner-share-${index}`); if(input) total += parseInt(input.value) || 0; }); }
        function switchReportTab(tab) { document.querySelectorAll('#laporan-keuangan .tab').forEach(t=>t.classList.remove('active')); event.currentTarget.classList.add('active'); document.querySelectorAll('#laporan-keuangan .tab-content').forEach(c=>c.style.display='none'); document.getElementById('tab-'+tab).style.display='block'; if(tab==='history') renderReportHistory(); }

        function generateFinancialReport() {
            if(!checkRole('owner')) return;
            const start = document.getElementById('rep-start').value, end = document.getElementById('rep-end').value;
            if(!start || !end) return showToast("Pilih tanggal");
            
            const existingReport = appData.reportHistory.find(r => r.periodStart === start && r.periodEnd === end);
            const btnSave = document.getElementById('btn-save-lock-report');
            
            if(existingReport) {
                btnSave.disabled = true;
                btnSave.innerText = "Periode Sudah Tersimpan";
                showToast("Periode ini sudah terkunci.");
            } else {
                btnSave.disabled = false;
                btnSave.innerText = "2. SIMPAN & KUNCI LAPORAN";
            }
            
            document.getElementById('report-result').style.display = 'block';
            document.getElementById('final-result').style.display = 'none';
            document.getElementById('print-period').innerText = `${start} s/d ${end}`;
            
            const trxInPeriod = appData.transactions.filter(t => t.date >= start && t.date <= end && t.amount > 0);
            const incomeTrx = trxInPeriod.filter(t => t.type === 'income');
            const expenseTrx = trxInPeriod.filter(t => t.type === 'expense');
            const injectTrx = trxInPeriod.filter(t => t.type === 'modal_in');
            const savingOutTrx = trxInPeriod.filter(t => t.type === 'saving_out');
            const savingInTrx = trxInPeriod.filter(t => t.type === 'saving_in');
            const emergOutTrx = trxInPeriod.filter(t => t.type === 'emergency_saving_out');
            const emergInTrx = trxInPeriod.filter(t => t.type === 'emergency_saving_in');
            
            const totalIncome = incomeTrx.reduce((a,b)=>a+b.amount,0);
            const totalExpense = expenseTrx.reduce((a,b)=>a+b.amount,0);
            const totalInject = injectTrx.reduce((a,b)=>a+b.amount,0);
            const totalSavingsOut = savingOutTrx.reduce((a,b)=>a+b.amount,0);
            const totalSavingsIn = savingInTrx.reduce((a,b)=>a+b.amount,0);
            const totalEmergOut = emergOutTrx.reduce((a,b)=>a+b.amount,0);
            const totalEmergIn = emergInTrx.reduce((a,b)=>a+b.amount,0);
            
            let totalSalary = 0; 
            incomeTrx.forEach(t=> { 
                if((t.details.category === 'service' || !t.details.category) && t.details?.commission) totalSalary += t.details.commission; 
            });
            expenseTrx.forEach(t => {
                if(t.details.description && t.details.description.includes('Bonus')) {
                    totalSalary += t.amount;
                }
            });

            const opProfit = totalIncome - totalExpense - totalSalary;

            const allInjectTrx = appData.transactions.filter(t => t.type === 'modal_in');
            const totalInjectAllTime = allInjectTrx.reduce((a,b)=>a+b.amount,0);
            
            const cashMovementInPeriod = totalIncome - totalExpense - totalSalary - totalSavingsOut + totalSavingsIn - totalEmergOut + totalEmergIn;

            const cashOpening = totalInjectAllTime;
            const cashClosing = cashOpening + cashMovementInPeriod;

            const currentSavings = appData.config.savings;
            const savingsMovement = totalSavingsOut - totalSavingsIn; 
            const savingsOpening = currentSavings - savingsMovement;
            const savingsClosing = savingsOpening + savingsMovement;

            const currentEmerg = appData.config.emergencySavings;
            const emergMovement = totalEmergOut - totalEmergIn; 
            const emergOpening = currentEmerg - emergMovement;
            const emergClosing = emergOpening + emergMovement;

            document.getElementById('rep-cash-open').innerText = formatRupiah(cashOpening);
            document.getElementById('rep-cash-inject').innerText = formatRupiah(totalInject);
            document.getElementById('rep-income-total').innerText = formatRupiah(totalIncome);
            document.getElementById('rep-exp-total').innerText = formatRupiah(totalExpense);
            document.getElementById('rep-salary-total').innerText = formatRupiah(totalSalary);
            document.getElementById('rep-savings-out').innerText = formatRupiah(totalSavingsOut);
            document.getElementById('rep-savings-in').innerText = formatRupiah(totalSavingsIn);
            document.getElementById('rep-emergency-out').innerText = formatRupiah(totalEmergOut);
            document.getElementById('rep-emergency-in').innerText = formatRupiah(totalEmergIn);
            document.getElementById('rep-cash-close').innerText = formatRupiah(cashClosing);
            document.getElementById('rep-sav-open').innerText = formatRupiah(savingsOpening);
            document.getElementById('rep-sav-deposit').innerText = formatRupiah(totalSavingsOut);
            document.getElementById('rep-sav-withdraw').innerText = formatRupiah(totalSavingsIn);
            document.getElementById('rep-sav-close').innerText = formatRupiah(savingsClosing);

            const emergSection = document.getElementById('emergency-report-section');
            if(totalEmergOut > 0 || totalEmergIn > 0) {
                emergSection.style.display = 'block';
                document.getElementById('rep-emerg-open').innerText = formatRupiah(emergOpening);
                document.getElementById('rep-emerg-deposit').innerText = formatRupiah(totalEmergOut);
                document.getElementById('rep-emerg-withdraw').innerText = formatRupiah(totalEmergIn);
                document.getElementById('rep-emerg-close').innerText = formatRupiah(emergClosing);
            } else {
                emergSection.style.display = 'none';
            }

            document.getElementById('pl-gross').innerText = formatRupiah(totalIncome);
            document.getElementById('pl-exp').innerText = formatRupiah(totalExpense);
            document.getElementById('pl-salary').innerText = formatRupiah(totalSalary);
            document.getElementById('pl-net').innerText = formatRupiah(opProfit);
            document.getElementById('temp-op-profit').innerText = formatRupiah(opProfit);

            const ownerContainer = document.getElementById('owner-shares-list-container');
            ownerContainer.innerHTML = '';
            appData.config.owners.forEach((owner, index) => {
                const div = document.createElement('div');
                div.className = 'owner-share-item';
                div.innerHTML = `
                    <div class="owner-share-info">
                        <div class="owner-share-label">${owner.name}</div>
                        <input type="number" value="${owner.share}" id="close-owner-share-${index}" 
                               onchange="window.updateClosingPreview(${opProfit}, ${totalSavingsOut}, ${totalEmergOut})" style="width:80px; padding:4px; display:inline-block;"> %
                    </div>
                    <div class="owner-share-calc" id="close-owner-calc-${index}">Rp 0</div>
                `;
                ownerContainer.appendChild(div);
            });
            updateClosingPreview(opProfit, totalSavingsOut, totalEmergOut);

            const incTb = document.querySelector('#report-inc-table tbody'); incTb.innerHTML='';
            incomeTrx.forEach(t => {
                let name = '-', info = '-';
                if(t.details.category === 'good') { name = t.details.productName || '-'; info = 'Barang'; }
                else { name = t.details.productName || '-'; const emp = appData.employees.find(e=>e.id===t.details.employeeId)?.name || '-'; info = `Barber: ${emp}`; }
                incTb.innerHTML += `<tr><td>${t.date}</td><td>${t.details.category === 'good' ? 'Barang' : 'Layanan'}</td><td>${name}</td><td>${info}</td><td style="text-align:center">${t.details.qty||1}</td><td>${formatRupiah(t.amount)}</td></tr>`;
            });
            const expTb = document.querySelector('#report-exp-table tbody'); expTb.innerHTML='';
            expenseTrx.forEach(t => { expTb.innerHTML += `<tr><td>${t.date}</td><td>${t.details.description}</td><td>${formatRupiah(t.amount)}</td></tr>`; });
        }

        function updateClosingPreview(netProfit, savingsDeposit, emergencyDeposit) {
            const distributable = netProfit - savingsDeposit - emergencyDeposit;
            let totalPct = 0;
            const shares = [];
            appData.config.owners.forEach((owner, index) => {
                const input = document.getElementById(`close-owner-share-${index}`);
                const display = document.getElementById(`close-owner-calc-${index}`);
                const pct = parseInt(input ? input.value : 0) || 0;
                totalPct += pct;
                const amount = Math.floor(distributable * (pct / 100));
                if(display) display.innerText = formatRupiah(amount);
                shares.push({ id: owner.id, name: owner.name, pct: pct, amount: amount, kasbon: 0, netAmount: amount });
            });
            const warningDiv = document.querySelector('.owner-shares-list');
            if(warningDiv) {
                if(totalPct !== 100) warningDiv.style.border = "1px solid var(--danger)";
                else warningDiv.style.border = "1px solid transparent";
            }
            return shares;
        }

        function printReport() {
            const reportResult = document.getElementById('report-result');
            if(reportResult.style.display === 'none') return showToast("Buat laporan dulu.");
            window.print();
        }

        async function processClosingMonth() {
            if(!checkRole('owner')) return;
            const sav = getVal('input-savings-amount');
            const emerg = getVal('input-emergency-amount');
            
            const rawProfit = document.getElementById('temp-op-profit').innerText;
            const profit = parseInt(rawProfit.replace(/[^0-9]/g,''))||0;
            const s=document.getElementById('rep-start').value, e=document.getElementById('rep-end').value;
            if(!s||!e) throw new Error("Pilih periode");
            
            const isLocked = appData.reportHistory.some(r => r.periodStart === s && r.periodEnd === e);
            if(isLocked) throw new Error("Periode ini sudah tersimpan.");
            
            let totalPctCheck = 0;
            let calculatedShares = updateClosingPreview(profit, sav, emerg);

            // V1.7.2: DEDUCT KASBON OWNER
            calculatedShares.forEach((share) => {
                // Sum all owner_kasbon transactions for this owner ID
                const ownerKasbons = appData.transactions.filter(t => 
                    t.type === 'owner_kasbon' && 
                    t.details.ownerId === share.id
                );
                const totalKasbon = ownerKasbons.reduce((sum, t) => sum + t.amount, 0);
                
                share.kasbon = totalKasbon;
                share.netAmount = share.amount - totalKasbon; // Reduce share by debt
                
                totalPctCheck += share.pct;
            });

            if(totalPctCheck !== 100) throw new Error(`Total persentase harus 100%. Saat ini ${totalPctCheck}%`);

            const finalProfit = profit - sav - emerg;
            const currentCashText = document.getElementById('rep-cash-close').innerText;
            const currentCash = parseInt(currentCashText.replace(/[^0-9]/g,'')) || 0;
            
            // Net Cash after all owner payouts (net of kasbon)
            const totalOwnerNetPayout = calculatedShares.reduce((a,b)=>a+b.netAmount,0);
            
            // V1.7.2 FIX: Logic perubahan agar Saldo Akhir menjadi 0
            // Karena Kasbon Owner mungkin tidak mengurangi fisik kas saat transaksi (masih dianggap uang kas),
            // maka saat 'Tutup Buku', uang hasil bagi hasil yang DIPOTONG KASBON sebenarnya tidak keluar dari kas fisik.
            // Namun secara akuntansi untuk user, saldo harus 0.
            // Jadi kita harus mengurangi 'Total Owner Net Payout' PLUS 'Total Kasbon yang dipotong'.
            // Total deduction = Net Payout (uang diambil owner) + Kasbon (uang disimpan/tetap di kas tapi dianggap 'bayar hutang').
            
            const totalOwnerKasbonDeduction = calculatedShares.reduce((a,b)=>a+b.kasbon,0);
            
            const finalCash = currentCash - sav - emerg - totalOwnerNetPayout - totalOwnerKasbonDeduction;
            
            pendingReportData = {
                start: s, end: e,
                profit: profit, sav: sav, emerg: emerg, finalProfit: finalProfit,
                shares: calculatedShares, 
                finalCash: finalCash,
                grossIncome: parseInt(document.getElementById('pl-gross').innerText.replace(/[^0-9]/g,'')),
                expense: parseInt(document.getElementById('pl-exp').innerText.replace(/[^0-9]/g,'')),
                salary: parseInt(document.getElementById('pl-salary').innerText.replace(/[^0-9]/g,''))
            };
            
            const finalContainer = document.getElementById('final-result');
            finalContainer.style.display = 'block';
            const finalList = document.getElementById('final-shares-display');
            finalList.innerHTML = '';
            
            calculatedShares.forEach(sh => {
                finalList.innerHTML += `
                <div class="slip-card">
                    <h4 style="margin:0 0 10px 0; color:#000;">${sh.name} (${sh.pct}%)</h4>
                    <div class="slip-row">
                        <span>Bagi Hasil Kotor:</span>
                        <span>${formatRupiah(sh.amount)}</span>
                    </div>
                    ${sh.kasbon > 0 ? `
                    <div class="slip-row slip-deduction">
                        <span>Potongan Kasbon:</span>
                        <span>-${formatRupiah(sh.kasbon)}</span>
                    </div>` : ''}
                    <div class="slip-row final">
                        <span>Terima Bersih:</span>
                        <span>${formatRupiah(sh.netAmount)}</span>
                    </div>
                </div>`;
            });

            finalList.innerHTML += `
                <div style="border-top: 2px dashed var(--border); margin-top: 10px; padding-top: 10px;">
                    <div class="owner-share-item">
                        <div class="owner-share-info" style="color:var(--text-muted)">Total Bagi Hasil (Diambil Bersih)</div>
                        <div class="owner-share-calc" style="color:var(--primary)">${formatRupiah(totalOwnerNetPayout)}</div>
                    </div>
                    <div class="owner-share-item" style="background: rgba(0,0,0,0.4); border: 1px solid var(--border);">
                        <div class="owner-share-info" style="color:var(--text-main); font-weight:bold;">SISA SALDO KAS</div>
                        <div class="owner-share-calc" style="color:var(--text-main); font-size:1.2rem;">${formatRupiah(finalCash)}</div>
                    </div>
                </div>
            `;
            
            showToast("Laporan Siap Disimpan. Silakan Cek Angka.");
            document.getElementById('btn-save-lock-report').style.display = 'block';
        }

        async function saveClosingMonth() {
            if(!checkRole('owner')) return;
            if(!pendingReportData) return showToast("Proses laporan dulu.");
            
            showLoading(true, "Menyimpan Data & Sinkronisasi Kas...");
            try {
                const sav = pendingReportData.sav || 0;
                const emerg = pendingReportData.emerg || 0;
                const calculatedShares = pendingReportData.shares || [];

                appData.config.savings += sav;
                appData.config.emergencySavings += emerg;
                await updateConfigInFirebase();

                if(sav > 0) { await addDoc(collection(db, "transactions"), { date:new Date().toISOString().split('T')[0], type:'saving_out', amount: sav, details:{description:'Setor Tabungan (Tutup Buku)'} }); }
                if(emerg > 0) { await addDoc(collection(db, "transactions"), { date:new Date().toISOString().split('T')[0], type:'emergency_saving_out', amount: emerg, details:{description:'Setor Dana Darurat (Tutup Buku)'} }); }
                
                // Save the NET amount (after kasbon deduction) as expense/share payout
                const totalOwnerNetPayout = calculatedShares.reduce((a, b) => a + b.netAmount, 0);
                if (totalOwnerNetPayout > 0) {
                    await addDoc(collection(db, "transactions"), { 
                        date: new Date().toISOString().split('T')[0], 
                        type: 'expense', 
                        amount: totalOwnerNetPayout, 
                        details: { description: 'Bagi Hasil Owner (Bersih - Potong Kasbon)' } 
                    });
                }
                
                const historyRecord = { 
                    periodStart: pendingReportData.start, 
                    periodEnd: pendingReportData.end, 
                    grossIncome: pendingReportData.grossIncome,
                    expense: pendingReportData.expense,
                    salary: pendingReportData.salary,
                    savingsDeposit: sav,
                    emergencyDeposit: emerg,
                    netProfit: pendingReportData.finalProfit,
                    owners: calculatedShares.map(s => ({
                         id: s.id, name: s.name, pct: s.pct, 
                         amount: s.amount, 
                         kasbon: s.kasbon, 
                         netAmount: s.netAmount 
                    })),
                    cashClose: pendingReportData.finalCash
                };
                
                const docRef = await addDoc(collection(db, "reportHistory"), historyRecord);
                await updateDoc(docRef, { id: docRef.id });

                await fetchAllData();
                
                pendingReportData = null;
                document.getElementById('final-result').style.display = 'none';
                document.getElementById('btn-save-lock-report').style.display = 'none';
                document.getElementById('report-result').style.display = 'none';
                showToast("Laporan Terkunci & Data Disinkronisasi.");

            } catch (error) {
                console.error(error);
                showToast("Gagal Proses: " + error.message);
            } finally {
                showLoading(false);
            }
        }

        function renderReportHistory() {
            if(!checkRole('owner')) return;
            const container = document.getElementById('history-container');
            container.innerHTML = '';
            if (appData.reportHistory.length === 0) {
                container.innerHTML = '<div class="card" style="text-align:center; padding:40px;">Belum ada laporan tersimpan.</div>';
                return;
            }
            appData.reportHistory.forEach(h => {
                let cardHtml = `
                    <div class="card report-card">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                            <h3 style="font-size:1.1rem; color:var(--primary);">Periode: ${h.periodStart} s/d ${h.periodEnd}</h3>
                            <button class="btn btn-danger btn-sm" onclick="window.editLockedReport('${h.id}')">üóëÔ∏è Buka Kunci</button>
                        </div>
                        <div class="grid-2" style="margin-top:10px;">
                            <div><div class="stat-label">Pendapatan Kotor</div><div>${formatRupiah(h.grossIncome)}</div></div>
                            <div><div class="stat-label">Pengeluaran</div><div style="color:var(--danger)">${formatRupiah(h.expense)}</div></div>
                            <div><div class="stat-label">Gaji Karyawan</div><div>${formatRupiah(h.salary)}</div></div>
                            <div><div class="stat-label">Laba Bersih</div><div style="font-weight:bold; color:var(--success)">${formatRupiah(h.netProfit)}</div></div>
                        </div>
                    </div>
                    <div class="card" style="border-color: var(--success); border-left: 5px solid var(--success);">
                        <h4 style="color: var(--success); border-bottom: 1px solid #333; padding-bottom:5px; margin-bottom:10px;">Ringkasan Hasil Bagi</h4>
                        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:15px; margin-bottom:15px;">
                            <div><small style="color:#aaa">Setor Tabungan</small><div><div style="color:var(--savings)">${formatRupiah(h.savingsDeposit)}</div></div>
                            <div><small style="color:#aaa">Setor Dana Darurat</small><div><div style="color:var(--emergency)">${formatRupiah(h.emergencyDeposit)}</div></div>
                            <div><small style="color:#aaa">Laba Dibagi</small><div><div style="font-weight:bold;">${formatRupiah(h.netProfit - h.savingsDeposit - h.emergencyDeposit)}</div></div>
                        </div>
                        <div class="owner-shares-list">
                `;
                if(h.owners && Array.isArray(h.owners)) {
                    h.owners.forEach(o => {
                        const kasbonBadge = o.kasbon > 0 ? `<span style="color:var(--danger); font-size:0.8rem;">(Kasbon: -${formatRupiah(o.kasbon)})</span>` : '';
                        cardHtml += `<div class="owner-share-item">
                            <div class="owner-share-info">${o.name} (${o.pct}%) ${kasbonBadge}</div>
                            <div class="owner-share-calc">${formatRupiah(o.netAmount)}</div>
                        </div>`;
                    });
                }
                
                cardHtml += `</div>
                <div class="report-summary-row total" style="margin-top:10px; border-top:2px solid var(--success); padding-top:10px;">
                    <span style="color:var(--text-muted)">Sisa Saldo Akhir Kas (Periode Ini)</span>
                    <span>${formatRupiah(h.cashClose)}</span>
                </div>
                </div><hr style="border:0; border-top:1px dashed var(--border); margin: 20px 0;">`;
                
                container.innerHTML += cardHtml;
            });
        }
        
        async function editLockedReport(id) {
            if(!checkRole('owner')) return;
            if(confirm('Buka kunci laporan ini? Data kas akan dikembalikan.')) {
                await deleteDoc(doc(db, "reportHistory", id));
                await fetchAllData(); 
                showToast("Riwayat dihapus");
                renderReportHistory(); 
            }
        }

        // --- SETTINGS & UTILS ---
        async function saveConfig() { 
            if(!checkRole('owner')) return; 
            const newOwners = [];
            appData.config.owners.forEach((owner, index) => {
                const nameIn = document.getElementById(`owner-name-${index}`);
                const shareIn = document.getElementById(`owner-share-${index}`);
                if(nameIn && shareIn) {
                    newOwners.push({
                        id: owner.id,
                        name: nameIn.value,
                        share: parseInt(shareIn.value) || 0
                    });
                }
            });
            appData.config.owners = newOwners;
            appData.config.businessName = document.getElementById('conf-business-name').value || "Barbershop";
            await updateConfigInFirebase(); 
            applyConfig(); 
            showToast("Config Tersimpan"); 
        }
        async function updateConfigInFirebase() { await setDoc(doc(db, "config", "main_config"), appData.config); }
        function applyConfig() {
            document.getElementById('brand-name').innerText = appData.config.businessName;
            document.getElementById('conf-business-name').value = appData.config.businessName;
            document.getElementById('print-business-name').innerText = appData.config.businessName;
            renderOwnerSettings();
        }
        async function manualSavingsTransaction() { 
            if(!checkRole('owner')) return; 
            const act = document.getElementById('saving-action-type').value, amt = getVal('saving-manual-amount'); 
            if(!amt) return showToast("Isi nominal"); 
            let realCash = 0; appData.transactions.forEach(t => { if(t.type==='income') realCash+=t.amount; if(t.type==='expense') realCash-=t.amount; if(t.type==='modal_in') realCash+=t.amount; if(t.type==='saving_out') realCash-=t.amount; if(t.type==='saving_in') realCash+=t.amount; if(t.type==='emergency_saving_out') realCash-=t.amount; if(t.type==='emergency_saving_in') realCash+=t.amount; }); 
            if(act==='deposit') { if(amt > realCash) return showToast("Saldo kas fisik kurang"); appData.config.savings+=amt; await addDoc(collection(db, "transactions"), { id:Date.now(), date:new Date().toISOString().split('T')[0], type:'saving_out', amount:amt, details:{description:'Setor Manual'} }); } 
            else { if(amt>appData.config.savings) return showToast("Saldo tabungan kurang"); appData.config.savings-=amt; await addDoc(collection(db, "transactions"), { id:Date.now(), date:new Date().toISOString().split('T')[0], type:'saving_in', amount:amt, details:{description:'Tarik Manual'} }); } 
            await updateConfigInFirebase(); await fetchAllData(); document.getElementById('saving-manual-amount').value=''; 
        }
        async function manualSavingsCorrection() { 
            if(!checkRole('owner')) return; 
            const r = prompt("Alasan:"); if(!r) return; 
            const amt = getVal('saving-correction-amount'); 
            if(!amt) return showToast("Isi nominal"); 
            appData.config.savings += amt; 
            await addDoc(collection(db, "transactions"), { id:Date.now(), date:new Date().toISOString().split('T')[0], type:'saving_correction', amount:amt, details:{description:`KOREKSI: ${r}`} }); 
            await updateConfigInFirebase(); await fetchAllData(); document.getElementById('saving-correction-amount').value=''; 
        }
        async function manualEmergencyTransaction() { 
            if(!checkRole('owner')) return; 
            const act = document.getElementById('emergency-action-type').value, amt = getVal('emergency-manual-amount'); 
            if(!amt) return showToast("Isi nominal"); 
            let realCash = 0; appData.transactions.forEach(t => { if(t.type==='income') realCash+=t.amount; if(t.type==='expense') realCash-=t.amount; if(t.type==='modal_in') realCash+=t.amount; if(t.type==='saving_out') realCash-=t.amount; if(t.type==='saving_in') realCash+=t.amount; if(t.type==='emergency_saving_out') realCash-=t.amount; if(t.type==='emergency_saving_in') realCash+=t.amount; }); 
            if(act==='deposit') { if(amt > realCash) return showToast("Saldo kas fisik kurang"); appData.config.emergencySavings+=amt; await addDoc(collection(db, "transactions"), { id:Date.now(), date:new Date().toISOString().split('T')[0], type:'emergency_saving_out', amount:amt, details:{description:'Setor Dana Darurat Manual'} }); } 
            else { if(amt>appData.config.emergencySavings) return showToast("Saldo dana darurat kurang"); appData.config.emergencySavings-=amt; await addDoc(collection(db, "transactions"), { id:Date.now(), date:new Date().toISOString().split('T')[0], type:'emergency_saving_in', amount:amt, details:{description:'Tarik Dana Darurat Manual'} }); } 
            await updateConfigInFirebase(); await fetchAllData(); document.getElementById('emergency-manual-amount').value=''; 
        }
        async function manualEmergencyCorrection() { 
            if(!checkRole('owner')) return; 
            const r = prompt("Alasan:"); if(!r) return; 
            const amt = getVal('emergency-correction-amount'); 
            if(!amt) return showToast("Isi nominal"); 
            appData.config.emergencySavings += amt; 
            await addDoc(collection(db, "transactions"), { id:Date.now(), date:new Date().toISOString().split('T')[0], type:'emergency_saving_correction', amount:amt, details:{description:`KOREKSI DANA DARURAT: ${r}`} }); 
            await updateConfigInFirebase(); await fetchAllData(); document.getElementById('emergency-correction-amount').value=''; 
        }
        async function addCapitalInjection() { 
            if(!checkRole('owner')) return; 
            const btn = event.target;
            const originalText = btn.innerText;
            const d = document.getElementById('inject-date').value, a = getVal('inject-amount'); 
            if(!d||!a) return showToast("Lengkapi data"); 
            
            try {
                btn.innerText = "PROSES...";
                btn.disabled = true;
                await addDoc(collection(db, "transactions"), { id:Date.now(), date:d, type:'modal_in', amount:a, details:{description:'Inject Modal'} }); 
                await fetchAllData(); 
                document.getElementById('inject-amount').value=''; 
                showToast("Modal Ditambahkan");
            } catch(e) { showToast(e.message); }
            finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }
        
        function exportToExcel() {
            if(!checkRole('owner')) return;
            const start = document.getElementById('rep-start').value || '1970-01-01';
            const end = document.getElementById('rep-end').value || '2099-12-31';
            
            const filtered = appData.transactions.filter(t => t.date >= start && t.date <= end);
            if(filtered.length === 0) return showToast("Tidak ada data untuk diexport");

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Tanggal,Tipe,Kategori,Keterangan,Jumlah,Nominal\n";

            filtered.forEach(t => {
                const date = t.date;
                const type = t.type === 'income' ? 'Pemasukan' : (t.type === 'kas_bon' ? 'Kas Bon' : (t.type === 'owner_kasbon' ? 'Kasbon Owner' : 'Pengeluaran'));
                let cat = t.details.category || '-';
                let desc = t.details.description || '';
                let qty = t.details.qty || '-';
                let amt = t.amount;
                
                if(t.details.category === 'good') {
                    cat = 'Barang';
                    desc = t.details.productName;
                } else if (t.details.category === 'service') {
                    cat = 'Layanan';
                    desc = t.details.productName;
                    const emp = appData.employees.find(e=>e.id===t.details.employeeId)?.name || '-';
                    desc += ` (Barber: ${emp})`;
                }

                csvContent += `${date},${type},${cat},"${desc}",${qty},${amt}\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `laporan_keuangan_${start}_sd_${end}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function backupData() { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData)); const downloadAnchorNode = document.createElement('a'); downloadAnchorNode.setAttribute("href", dataStr); downloadAnchorNode.setAttribute("download", "backup_barber_" + new Date().toISOString().slice(0,10) + ".json"); document.body.appendChild(downloadAnchorNode); downloadAnchorNode.click(); downloadAnchorNode.remove(); }
        async function initiateDataReset() {
            if(!checkRole('owner')) return;
            const pass = prompt("Password:"); if(!pass) return;
            try { await reauthenticateWithCredential(currentUser, EmailAuthProvider.credential(currentUser.email, pass)); }
            catch (e) { showToast("Password Salah"); return; }
            if(!confirm("HAPUS SEMUA DATA?")) return;
            if(prompt("Ketik 'HAPUS'") !== "HAPUS") return;
            await executeDataReset();
        }
        async function executeDataReset() {
            showLoading(true, "Menghapus...");
            try {
                const cols = ['transactions', 'products', 'employees', 'goods', 'payrollHistory', 'reportHistory'];
                for(const col of cols) { const snap = await getDocs(collection(db, col)); await Promise.all(snap.docs.map(d=>deleteDoc(d.ref))); }
                appData.config = { businessName: "BARBERSHOP BARU", owners: [{id:"1", name:"Owner 1", share:50}, {id:"2", name:"Owner 2", share:50}], savings: 0, emergencySavings: 0 };
                await updateConfigInFirebase();
                showToast("RESET OK"); await fetchAllData(); window.location.reload();
            } catch(e) { showToast(e.message); }
            finally { showLoading(false); }
        }

        // --- ANALYTICS CHARTS ---
        function initCharts() {
            if (typeof Chart === 'undefined') {
                console.warn("Chart.js belum termuat. Grafik akan diabaikan sementara.");
                return;
            }

            const months = {};
            appData.transactions.filter(t => t.type === 'income' && t.amount > 0).forEach(t => {
                const d = new Date(t.date);
                const key = `${d.getFullYear()}-${d.getMonth()}`; 
                if(!months[key]) months[key] = 0;
                months[key] += t.amount;
            });
            const sortedKeys = Object.keys(months).sort().slice(-6);
            const chartLabels = sortedKeys.map(k => {
                const [y, m] = k.split('-');
                const date = new Date(y, m);
                return date.toLocaleDateString('id-ID', { month: 'short' });
            });
            const chartData = sortedKeys.map(k => months[k]);

            if(chartIncomeInstance) chartIncomeInstance.destroy();

            chartIncomeInstance = new Chart(document.getElementById('chart-income'), {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'Pendapatan',
                        data: chartData,
                        borderColor: '#d4af37',
                        backgroundColor: 'rgba(212, 175, 55, 0.2)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { grid: { color: '#333' }, ticks: { color: '#aaa' } },
                        x: { grid: { display: false }, ticks: { color: '#aaa' } }
                    }
                }
            });

            let serviceAmt = 0, goodAmt = 0;
            appData.transactions.filter(t => t.type === 'income' && t.amount > 0).forEach(t => {
                if(t.details.category === 'good') goodAmt += t.amount;
                else serviceAmt += t.amount;
            });

            if(chartPieInstance) chartPieInstance.destroy();

            chartPieInstance = new Chart(document.getElementById('chart-pie'), {
                type: 'doughnut',
                data: {
                    labels: ['Layanan (Jasa)', 'Barang'],
                    datasets: [{
                        data: [serviceAmt, goodAmt],
                        backgroundColor: ['#d4af37', '#2196f3'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { color: '#fff' } } }
                }
            });

            const barberStats = {};
            appData.transactions.filter(t => t.type === 'income' && t.details.category === 'service' && t.amount > 0).forEach(t => {
                const eid = t.details.employeeId;
                if(!barberStats[eid]) barberStats[eid] = 0;
                barberStats[eid] += t.amount;
            });
            
            const sortedBarbers = Object.entries(barberStats)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);
            
            const barberLabels = sortedBarbers.map(([id]) => {
                const emp = appData.employees.find(e => e.id === id);
                return emp ? emp.name : 'Unknown';
            });
            const barberOmsets = sortedBarbers.map(([, amt]) => amt);

            if(chartBarbersInstance) chartBarbersInstance.destroy();

            chartBarbersInstance = new Chart(document.getElementById('chart-barbers'), {
                type: 'bar',
                data: {
                    labels: barberLabels,
                    datasets: [{
                        label: 'Omset',
                        data: barberOmsets,
                        backgroundColor: '#4caf50',
                        borderRadius:4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: '#333' }, ticks: { color: '#aaa' } },
                        y: { grid: { display: false }, ticks: { color: '#aaa' } }
                    }
                }
            });
        }

        // --- EXPOSE FUNCTIONS TO WINDOW ---
        window.handleLogin = handleLogin; window.handleLogout = handleLogout; window.registerNewUser = registerNewUser; window.handleResetPassword = handleResetPassword;
        window.showSection = showSection; window.toggleTransactionFields = toggleTransactionFields; window.toggleCategoryFields = toggleCategoryFields;
        window.showEmployeeCommInfo = showEmployeeCommInfo; window.autoFillPrice = autoFillPrice; window.autoFillPriceGood = autoFillPriceGood;
        window.updateTotalPrice = updateTotalPrice; window.handleTransactionSubmit = handleTransactionSubmit; window.resetTransactionForm = resetTransactionForm;
        window.editTransaction = editTransaction; window.voidTransaction = voidTransaction; window.renderTransactionHistory = renderTransactionHistory;
        window.saveProduct = saveProduct; window.resetProductForm = resetProductForm; window.editProduct = editProduct; window.deleteProduct = deleteProduct;
        window.saveEmployee = saveEmployee; window.resetEmployeeForm = resetEmployeeForm; window.editEmployee = editEmployee; window.deleteEmployee = deleteEmployee;
        window.saveGood = saveGood; window.resetGoodForm = resetGoodForm; window.editGood = editGood; window.deleteGood = deleteGood;
        
        // Kas Bon & Payroll
        window.switchPayrollTab = switchPayrollTab; window.calculatePayroll = calculatePayroll; window.savePayrollHistory = savePayrollHistory; window.editPayrollHistory = editPayrollHistory;
        window.openKasBonModal = openKasBonModal; window.closeKasBonModal = closeKasBonModal; window.saveKasBon = saveKasBon;
        window.updatePaymentStatus = updatePaymentStatus; window.showPayrollDetail = showPayrollDetail; window.closePayrollDetailModal = closePayrollDetailModal; window.downloadPayrollSlip = downloadPayrollSlip;

        // Owner Kasbon (V1.7.2)
        window.saveOwnerKasBon = saveOwnerKasBon;

        window.switchReportTab = switchReportTab; window.generateFinancialReport = generateFinancialReport; window.updateClosingPreview = updateClosingPreview; window.processClosingMonth = processClosingMonth; window.saveClosingMonth = saveClosingMonth; window.editLockedReport = editLockedReport; window.printReport = printReport;
        window.saveConfig = saveConfig; window.renderOwnerSettings = renderOwnerSettings; window.addOwnerConfig = addOwnerConfig; window.removeOwnerConfig = removeOwnerConfig; window.updateOwnerTotalPct = updateOwnerTotalPct;
        window.manualSavingsTransaction = manualSavingsTransaction; window.manualSavingsCorrection = manualSavingsCorrection; 
        window.manualEmergencyTransaction = manualEmergencyTransaction; window.manualEmergencyCorrection = manualEmergencyCorrection;
        window.addCapitalInjection = addCapitalInjection;
        window.exportToExcel = exportToExcel; 
        window.backupData = backupData; window.initiateDataReset = initiateDataReset;
        window.loadMoreTransactions = loadMoreTransactions; 
        window.resetTransactionPagination = resetTransactionPagination; 

        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('trx-date').value = today; document.getElementById('inject-date').value = today;
            document.getElementById('trx-history-start').value = today; document.getElementById('trx-history-end').value = today;
            document.getElementById('current-date').innerText = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            setTimeout(() => {
                if(document.getElementById('dashboard').style.display !== 'none') {
                    initCharts();
                }
            }, 500);
        });
    </script>
</body>
</html>